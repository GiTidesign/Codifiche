<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Codici LEA (CRUD)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .device-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .device-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .highlight { background-color: yellow; font-weight: bold; }
        .section-title { border-bottom: 2px solid #0ea5e9; padding-bottom: 8px; margin-bottom: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-title .arrow { transition: transform 0.3s ease; }
        .section-title.collapsed .arrow { transform: rotate(-90deg); }
        .device-grid-container { transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin-bottom 0.5s ease-out; overflow: hidden; max-height: 5000px; opacity: 1; }
        .device-grid-container.hidden { max-height: 0; opacity: 0; margin-bottom: 0 !important; }
        .edit-mode-controls, .edit-mode-field { display: none; }
        .card-editing .view-mode-field { display: none; }
        .card-editing .edit-mode-field, .card-editing .edit-mode-controls { display: flex; }
        /* Stili per il Modal di Conferma */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; }
        .modal-box h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .modal-box p { margin-bottom: 1.5rem; }
        .modal-actions button { margin: 0 0.5rem; }
        /* Stili per il dropdown di ordinamento */
        .sort-dropdown { display: none; position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; right: 0; }
        .sort-dropdown button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; }
        .sort-dropdown button:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Gestore Codici LEA</h1>
            <p class="text-gray-600 mt-2">Esplora, modifica e gestisci dispositivi "Di Serie" e "Su Misura".</p>
        </header>

        <div class="mb-8">
            <input type="text" id="searchInput"
                   class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow"
                   placeholder="Cerca per nome prodotto, marca, codice LEA, categoria o patologia...">
        </div>

        <!-- Sezione Ortesi di Serie -->
        <section id="sectionSerieWrapper" class="mb-12">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="toggleSerie" class="text-2xl font-semibold text-sky-700 section-title flex-grow">
                    <span>Ortesi di Serie</span>
                    <span class="arrow text-sky-700">&#9660;</span>
                </h2>
                <div class="relative">
                     <button id="sortButtonSerie" class="ml-4 text-gray-500 hover:text-sky-600 p-2 rounded-full"><i class="fas fa-gear"></i></button>
                     <div id="sortDropdownSerie" class="sort-dropdown">
                        <button class="sort-option" data-sort-by="prodotto">Ordina per Prodotto (A-Z)</button>
                        <button class="sort-option" data-sort-by="marca">Ordina per Marca (A-Z)</button>
                     </div>
                </div>
                <button id="addDeviceSerie" class="ml-2 bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors"><i class="fas fa-plus"></i> Aggiungi</button>
            </div>
            <div id="devicesContainerSerieWrapper" class="device-grid-container">
                <div id="devicesContainerSerie" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
            </div>
            <p id="noResultsSerie" class="hidden text-center text-gray-500 mt-6">Nessun dispositivo "Di Serie" trovato per questa ricerca.</p>
        </section>

        <!-- Sezione Ortesi su Misura -->
        <section id="sectionSuMisuraWrapper" class="mb-12">
             <div class="flex justify-between items-center mb-4">
                <h2 id="toggleSuMisura" class="text-2xl font-semibold text-teal-700 section-title flex-grow">
                    <span>Ortesi su Misura</span>
                    <span class="arrow text-teal-700">&#9660;</span>
                </h2>
                 <div class="relative">
                     <button id="sortButtonSuMisura" class="ml-4 text-gray-500 hover:text-teal-600 p-2 rounded-full"><i class="fas fa-gear"></i></button>
                     <div id="sortDropdownSuMisura" class="sort-dropdown">
                        <button class="sort-option" data-sort-by="prodotto">Ordina per Prodotto (A-Z)</button>
                        <button class="sort-option" data-sort-by="marca">Ordina per Marca (A-Z)</button>
                     </div>
                </div>
                <button id="addDeviceSuMisura" class="ml-2 bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition-colors"><i class="fas fa-plus"></i> Aggiungi</button>
            </div>
            <div id="devicesContainerSuMisuraWrapper" class="device-grid-container">
                <div id="devicesContainerSuMisura" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-4"></div>
            </div>
            <p id="noResultsSuMisura" class="hidden text-center text-gray-500 mt-6">Nessun dispositivo "Su Misura" trovato per questa ricerca.</p>
        </section>
        
        <div id="noResultsGlobal" class="hidden text-center text-gray-500 mt-10">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="mt-2 text-xl">Nessun risultato trovato in nessuna categoria.</p>
            <p>Prova a modificare i termini di ricerca.</p>
        </div>

        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Strumenti Avanzati</h3>
            <div class="flex justify-center space-x-4">
                <button id="exportDataButton" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-download mr-2"></i>Esporta Dati</button>
                <button id="importDataButton" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-upload mr-2"></i>Importa Dati</button>
                <input type="file" id="importFileInput" class="hidden" accept=".json">
            </div>
        </footer>
    </div>
    
    <!-- Modal di Conferma -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">Conferma Azione</h3>
            <p id="modalText" class="text-gray-600">Sei sicuro di voler procedere?</p>
            <div class="modal-actions">
                <button id="cancelActionButton" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Annulla</button>
                <button id="confirmActionButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Conferma</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDocs, addDoc, updateDoc, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali ---
        let db, auth, userId;
        let allDevicesFromDB = []; // Cache locale dei dispositivi
        let currentSort = { serie: 'prodotto', suMisura: 'prodotto' }; // Stato di ordinamento
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const devicesCollectionPath = `/artifacts/${appId}/public/data/devices`;
        
        // Dati iniziali per popolare il database la prima volta
        const initialDevicesData = [
          // --- DISPOSITIVI DI SERIE (dal PDF ORTESI_DI_SERIE.pdf) ---
          { prodotto: "Spry Step Max / Toe off (Tutore gamba piede in carbonio)", marca: "Thuasne", codiciLEA: ["06.12.06.018 760"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Patologie neurologiche; Tutore per piede cadente;" },
          { prodotto: "Spry Step / Walk on (Tutore gamba piede in carbonio)", marca: "thuasne ottobock", codiciLEA: ["06.12.06.018 760"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Patologie neurologiche; Tutore per piede cadente;" },
          { prodotto: "Dynamic Walk (Tutore gamba piede in carbonio)", marca: "Centri", codiciLEA: ["06.12.06.018 760"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Patologie neurologiche; Tutore per piede cadente;" },
          { prodotto: "Pero-Med (Tutore gamba piede basso)", marca: "Thuasne", codiciLEA: ["06.12.06.033 90"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Patologie neurologiche; Tutore per piede cadente; Piede flaccido; Paresi peroneale;" },
          { prodotto: "Af Servo (Tutore gamba piede basso)", marca: "Smart reha", codiciLEA: ["061206042 111", "061291424 70", "061291517 21"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Ictus, lesioni della colonna, charcot-marie-tooth" },
          { prodotto: "Dictus (Tutore gamba piede basso)", marca: "Podartis", codiciLEA: ["061206039 93", "061291218 87"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "equinismi spastici di media entità, cadute flaccide del piede" },
          { prodotto: "Malleo Neurexa (Tutore gamba piede basso)", marca: "Ottobock", codiciLEA: ["061206042 111", "061291424 70", "061291436 21,30"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "ictus, sclerosi multipla, patologie neurologiche" },
          { prodotto: "Push ortho (Tutore gamba piede basso flessibile)", marca: "Eumedica", codiciLEA: ["061206036 435", "061291517 21"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Ridotto controllo dei muscoli elevatori del piede, instabilità di caviglia" },
          { prodotto: "Lift Foot (tutore gamba piede in elastico)", marca: "itop", codiciLEA: ["06.12.06.045 160", "06.12.91.436 21,30"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortedi Afo", patologie: "Piede cadente" },
          { prodotto: "Saebo Step (Tutore gamba piede basso)", marca: "Saebo", codiciLEA: ["061206036 435", "aggiuntivi per step kit barefoot: 061291424, 061291517"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi AFO", patologie: "Piede cadente" },
          { prodotto: "Air Soft (Tutore palmare per mano- polso)", marca: "Tielle", codiciLEA: ["060613009 345"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "Lesioni neurologiche dell'arto superiore con conseguenti paralisi spastiche o flaccide dell'arto superiore."},
          { prodotto: "Saebo Strech (Tutore palmare statico)", marca: "Saebo", codiciLEA: ["06.06.13.012 390", "06.06.91.103 62,40", "06.06.91.112 23", "06.06.91.106 125,80"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "Lesioni neurologiche dell'arto superiore con conseguenti paralisi spastiche."},
          { prodotto: "Saebo Glove (Guanto)", marca: "Saebo", codiciLEA: ["Non specificato nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "lesioni neurologiche e ortopediche"},
          { prodotto: "Ginocchiera steccata", marca: "Non specificata", codiciLEA: ["Non specificato nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi coscia gamba", patologie: "Lesioni a carico dei legamenti e meniscali"},
          { prodotto: "Ginocchiera articolata", marca: "Non specificata", codiciLEA: ["Non specificato nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi coscia gamba", patologie: "Lesioni a carico dei legamenti e meniscali"},
          { prodotto: "Check (Ginocchiera per Recurvato)", marca: "Tielle", codiciLEA: ["06.12.09.036 435"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi coscia gamba", patologie: "iperestensione di ginocchio"},
          { prodotto: "Tutore Articolato di gomito", marca: "Tielle", codiciLEA: ["06.06.15.018*"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "fratture composte di gomito, lussazione o sub-lussazione del gomito"},
          { prodotto: "Tutore Di spalla", marca: "Tielle", codiciLEA: ["06.06.30.033*"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "Spalla cadente"},
          { prodotto: "Minerva/ Headmaster (Collare Rigido)", marca: "Tielle", codiciLEA: ["Non specificato nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi cervicale", patologie: "Instabilità del tratto cervicale dovuta a patologie neurologiche (S.L.A.)"},
          { prodotto: "Toe walking", marca: "Non specificata", codiciLEA: ["061203051 145,60 (x2)", "061291523 173,90 (x2)", "+ calzature non contemplate"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Plantari e scarpe", patologie: "toe walking idiopatico (cammino sulle punte)"},
          { prodotto: "Spinfast (Busto in stoffa rigidi con spallacci)", marca: "TLM", codiciLEA: ["060309012(donna) 340", "060309009(uomo) 310", "060391124 41,50", "060391130 29,70"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "Osteoporosi, decorso post operatorio, post trauma, cedimenti vertebrali."},
          { prodotto: "Ipertex/ Crossover (Busto in stoffa con spallacci)", marca: "TLM", codiciLEA: ["060309003 (uomo) 260", "060309006 (DONNA) 270", "060391121 34,30"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "osteoporosi, artrosi lombare, ipercifosi, post trauma"},
          { prodotto: "C35 (Busto per iperestensione)", marca: "Tielle", codiciLEA: ["06.03.09.113 229"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinali", patologie: "fratture e cedimenti vertebrali"},
          { prodotto: "Summer, 555, 500W (Busto in stoffa lombare)", marca: "TLM", codiciLEA: ["060309003 (UOMO) 260", "060309006 (DONNA) 270"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "osteoporosi, artrosi lombare"},
          { prodotto: "MZ (Busto crocera rigida)", marca: "Non specificata", codiciLEA: ["060309047 844,80"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinali", patologie: "Non specificata"},
          { prodotto: "Busto Boston (Busto per scoliosi)", marca: "Non specificata", codiciLEA: ["060309092 1073,40", "opzionale placca: 060391403"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "busto CLB (Busto per scoliosi)", marca: "Non specificata", codiciLEA: ["060309071 1106,80"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "Busto cheneau (busto per scoliosi)", marca: "Non specificata", codiciLEA: ["060309077 950"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "Busto lionese (Busto scoliosi)", marca: "Non specificata", codiciLEA: ["060309059 1598"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "Busto lionese per dorso curvo (Busto scoliosi)", marca: "Non specificata", codiciLEA: ["060309062 1619,60"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "Busto Sforzesco (Busto scoliosi)", marca: "Non specificata", codiciLEA: ["060309080 1509,10"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "Vacuum Bell (Dispositivo per Petto escavato)", marca: "Non specificata", codiciLEA: ["060309077 950", "060391406 90"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "petto escavato"},
          { prodotto: "Busto Milwaukee (Busto scoliosi)", marca: "Non specificata", codiciLEA: ["060318003 1044,70", "opzionali: 060391603, 060391606"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi Spinali", patologie: "scoliosi idiopatica giovanile"},
          { prodotto: "Corsetto compressivo dinamico (CDC) (Busto scoliosi)", marca: "Non specificata", codiciLEA: ["60309110 570", "060391403 140"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi Spinali", patologie: "petto carenato"},
          { prodotto: "Busto statico equilibrato", marca: "Non specificata", codiciLEA: ["060318033", "060391709", "numerosi opzionali"], tipoDispositivo: "Di Serie", categoriaOrtesi: "Ortesi spinali", patologie: "Non specificata"},
          { prodotto: "Scarpa di serie (Scarpe di serie e plantari per adulti)", marca: "Non specificata", codiciLEA: ["Vedere codici opzionali associati nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "artrosi del piede, artrite reumatoide, piede diabetico prevenzione primaria"},
          { prodotto: "Scarpa di serie pediatrica (scarpe di serie e plantari per bambini)", marca: "Non specificata", codiciLEA: ["Vedere codici opzionali associati nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "piede valgo piatto, ginocchio valgo"},
          { prodotto: "Bebax (Tutore per piede)", marca: "Tielle", codiciLEA: ["06.12.06.051 380", "opzionale asta: 061291430 N.L."], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "malformazioni dell'avampiede, metatarso varo-addotto-supinato, Post operatorio"},
          { prodotto: "Ponseti (Tutore per piede)", marca: "Tielle", codiciLEA: ["06.12.15.021 1150", "opzionale asta: 061291430 N.L."], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "piede torto congenito"},
          { prodotto: "Molla di Codivilla (tutore gamba piede)", marca: "Tielle", codiciLEA: ["061206042 111"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "piede cadente"},
          { prodotto: "Coxaflex / hipp med (Tutore per anca)", marca: "thuasne", codiciLEA: ["Non specificato nel PDF"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi d'anca", patologie: "Displasia congenita dell'anca"},
          { prodotto: "Coxa Fix (tutore d'anca)", marca: "Tielle", codiciLEA: ["06.12.15.012 720", "06.12.91.490 300"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortedi d'anca", patologie: "Artroplastica totale d'anca, fratture non consolidate del collo del femore, instabilità complesse dell'articolazione dell'anca."},
          { prodotto: "Plantari termoformabile", marca: "Non specificata", codiciLEA: ["06.12.03.024 84,10 (x2)", "06.12.91.103 1 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Plantari con talloniera avvolgente in multiform", marca: "Non specificata", codiciLEA: ["06.12.03.030 104 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Plantari con sistema Cad Cam", marca: "Non specificata", codiciLEA: ["06.12.03.042 138,40 (x2)", "06.12.91.103 1 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "plantari sensomotori", marca: "Non specificata", codiciLEA: ["061203042 138,40 (x2)", "061291103 1 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Piede piatto valgo"},
          { prodotto: "plantari su Calco gessato", marca: "Non specificata", codiciLEA: ["061203051 145,60 (x2)", "061291103 1 (x2)", "061291106 13,50 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "piede diabetico, piede deforme"},
          { prodotto: "Rialzo fino a 4 cm", marca: "Non specificata", codiciLEA: ["061203075 71,40"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Eterometria arti inferiori"},
          { prodotto: "rialzo da 4 a 8 cm", marca: "Non specificata", codiciLEA: ["061203078 83"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Eterometria arti inferiori"},
          { prodotto: "rialzo oltre gli 8 cm", marca: "Non specificata", codiciLEA: ["061203081 88,90"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Eterometria arti inferiori"},
          { prodotto: "Saebo step kit barefoot (ortesi di caviglia piede)", marca: "Non specificata", codiciLEA: ["061206036 435", "061291424 70", "061291517 21"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Hypex lite adulto/pediatrico (ortesi di ginocchio)", marca: "Albrecht", codiciLEA: ["061209024 595"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "ortesi di ginocchio jack PCL", marca: "Albrecht", codiciLEA: ["061209018 605", "061291230 46,50", "061291466 290 (x2)", "061291436 21,30 (x3)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Elbow track (ortesi di gomito)", marca: "Albrecht", codiciLEA: ["060615018 575,90", "060691203 285,70"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "Non specificata"},
          { prodotto: "CDS Knee brece flex/ext (ortesi di ginocchio dinamico)", marca: "Albrecht", codiciLEA: ["061209018 605", "061291466 290 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "CDS Knee brece amputation (ortesi di ginocchio dinamico)", marca: "Albrecht", codiciLEA: ["061209018 605", "061291466 290 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "CDS Ankle brace (ortesi gamba piede)", marca: "Albrecht", codiciLEA: ["061206027 543", "061291412 120 (x2)", "061291424 70", "061203024 84,10", "061291227 28", "061291505 80"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "CDS Elbow brace flex/ext (ortesi di gomito)", marca: "Albrecht", codiciLEA: ["060615018 605", "060691206 170", "060691203 285,70"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesiarto superiore", patologie: "Non specificata"},
          { prodotto: "CDS Wrist brace flex/ext (ortesi di polso dinamica)", marca: "Albrecht", codiciLEA: ["060613015 520", "060691103 62,40", "060691203 285,70", "060691106 125,50", "060691112 23"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "Non specificata"},
          { prodotto: "MKS lumbago plus (corsetto lombare)", marca: "Albrecht", codiciLEA: ["060309003 260", "opzionale: 60309006"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinale", patologie: "Non specificata"},
          { prodotto: "MKS Pontsana mobil (corsetto lombare)", marca: "Albrecht", codiciLEA: ["060309018 290", "opzionale: 60309015"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinale", patologie: "Non specificata"},
          { prodotto: "MKS Pontsana stabil (corsetto lombare)", marca: "Albrecht", codiciLEA: ["060309024 350", "060391115 6,90 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinale", patologie: "Non specificata"},
          { prodotto: "MKS Osteo plus (corsetto toraco lombare)", marca: "Albrecht", codiciLEA: ["060309021", "060391106", "060391121 (x2)", "060391115 (x2)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi spinale", patologie: "Non specificata"},
          { prodotto: "Guanto robotico", marca: "Non specificata", codiciLEA: ["060613012 390", "060691103 62,40", "060691118 26,80", "060691106 125,50", "060691112 23 (x5)"], tipoDispositivo: "Di Serie", categoriaOrtesi: "ortesi arto superiore", patologie: "Non specificata"},
          
          // --- DISPOSITIVI SU MISURA (dal PDF ORTESI_SU_MISURA.pdf) ---
          { prodotto: "Tutore gamba piede e T3-T4-T5", marca: "Non specificata", codiciLEA: ["06.12.06.027 543", "06.12.91.436 21,30 (x2)", "06.12.91.517 21"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi arto inferiori", patologie: "Paralisi cerebrali infantili, patologie neuromuscolari." },
          { prodotto: "Tutore nancy hilton T2", marca: "Non specificata", codiciLEA: ["06.12.06.036 435", "06.12.91.517 21"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi arto inferiore", patologie: "Paralisi cerebrali infantili, patologie neuromuscolari." },
          { prodotto: "Atlanta (Tutore Bacino coscia)", marca: "Non specificata", codiciLEA: ["06.12.15.009 1000", "06.12.91.493 470 (x2)", "06.12.91.508 75", "06.12.91.511 95", "06.12.91.436 21,30 (x4)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi d'anca", patologie: "Morbo di Perthes" },
          { prodotto: "Swash (Tutore bacino coscia)", marca: "Non specificata", codiciLEA: ["06.12.15.009 1000", "06.12.91.236 80", "06.12.91.436 21,30 (x4)", "06.12.91.484 190 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi per anca", patologie: "Non specificata"},
          { prodotto: "Doccia Gamba piede", marca: "Non specificata", codiciLEA: ["06.12.06.003 385", "06.12.91.218 55 (x3)", "06.12.91.227 40,50"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi arto inferiore", patologie: "Post operatorio, contenzione notturna."},
          { prodotto: "CaMO (Tutore Gamba piede a balestra)", marca: "Non specificata", codiciLEA: ["06.12.06.027 543", "06.12.91.436 21,30 (x2)", "06.12.91.418 70 (x6)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi arto inferiore", patologie: "Paralisi cerebrali infantili, mielomeningocele, stroke, forme diplegiche, tetraplegiche o emiplegiche"},
          { prodotto: "Doccia coscia gamba piede gin. Esteso", marca: "Non specificata", codiciLEA: ["06.12.12.003 549", "06.12.91.218 87,50 (x2)", "06.12.91.239 80", "06.12.91.221 50"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Non specificata", patologie: "Patologie neuromuscolari e mielomeningocele per lieve flessione del ginocchio."},
          { prodotto: "Doccia coscia gamba piede gin. Flesso", marca: "Non specificata", codiciLEA: ["06.12.12.012 487", "06.12.91.218* 87.50 (x2)", "06.12.91.239 80"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Piede Torto Congenito, Tibia Vara."},
          { prodotto: "Tutore Coscia Gamba Piede", marca: "Non specificata", codiciLEA: ["06.12.12.048 1950", "06.12.91.499 66,50", "06.12.91.433 40", "06.12.91.436 21,30 (x4)", "06.12.91.517 21", "06.12.91.457 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi Arti inferiori", patologie: "Esiti di PAA, emiplegie, diplegie, mielomeningocole, paralisi cerebrale infantile."},
          { prodotto: "RGO (Tutore Tronco - anca - coscia -gamba - piede)", marca: "Non specificata", codiciLEA: ["06.12.18.015 5920", "06.12.91.493 470 (x2)", "06.12.91.457 225 (x4)", "06.12.91.430 30 (x2)", "06.12.91.439 142,40 (x2)", "06.12.91.436 21,30 (x8)", "06.12.91.445 31,10 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi tronco- arti inferiori.", patologie: "Lesioni midollari, paraplegie congenite patologiche, spina bifida, poliomielite, distrofia muscolare, mielomeningocele."},
          { prodotto: "Neuro Swing (fior e gentz) (Tutore Gamba piede articolato in carbonio)", marca: "Non specificata", codiciLEA: ["06.12.06.027 543", "06.12.91.514 50", "06.12.91.433 40", "06.12.91.439 142,40", "06.12.91.418 70 (x25)", "06.12.91.445* 31,10", "06.12.91.412 120 (x2)", "06.12.91.424 70", "06.12.91.523 173,90"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Paralisi cerebrali infantili, mielomeningocele e lesioni midollari livello S1-S2- forme diplegiche distali o prossimali, emiplegie, stroke, ТВІ."},
          { prodotto: "Neuro swing (kafo) (Tutore Coscia Gamba Piede)", marca: "Non specificata", codiciLEA: ["06.12.12.048 1950", "06.12.91.499 66,50", "06.12.91.433 40", "06.12.91.436 21,30 (x4)", "06.12.91.517 21", "06.12.91.463 260", "06.12.91.439 142,40", "06.12.91.418 70 (x50)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi Arti inferiori", patologie: "Limitazione degli estensori di ginocchio"},
          { prodotto: "Salera (Tutore Tronco - anca - coscia -gamba - piede)", marca: "Non specificata", codiciLEA: ["06.12.12.048 1500 (x2)", "06.12.91.424 70 (x2)", "06.12.91.517 21 (x2)", "06.12.91.430 30 (x2)", "06.12.91.433 40 (x2)", "06.12.91.436* 21,30 (x6)", "06.12.91.439 142,40 (x2)", "06.12.91.445* (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi tronco- arti inferiori.", patologie: "Mielomeningocele e lesioni midollari corrispondenti o superiori al livello L2-L3."},
          { prodotto: "Doccia di posizione avambraccio- mano", marca: "Non specificata", codiciLEA: ["06.06.13.018 325", "06.06.91.106 125,50 (x2)", "06.06.91.215 25"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi arto superiore", patologie: "Mantenimento mano in posizione funzionale, caduta in flessione flaccida o spastica, trattamento deformità."},
          { prodotto: "Tutore d'anca (Swash)", marca: "Swash", codiciLEA: ["06.12.15.042 760x2 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi d'anca", patologie: "Non specificata"},
          { prodotto: "Scarpe su misura basse per plantari", marca: "Non specificata", codiciLEA: ["06.33.07.003 (x2)", "06.33.91.148 (x2)", "06.12.03.042 (x2)", "06.12.91.103 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Deformità del piede"},
          { prodotto: "Scarpe su misura alte per plantari", marca: "Non specificata", codiciLEA: ["06.33.07.006 (x2)", "06.33.91121 (x2)", "06.33.91.148 (x2)", "06.12.03.042 (x2)", "06.12.91.103 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Deformità del piede"},
          { prodotto: "Scarpe di rivestimento su misura bassa", marca: "Non specificata", codiciLEA: ["06.33.21.009 (x2)", "06.33.91.148 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Non specificata", patologie: "Deformità del piede"},
          { prodotto: "Scarpe di rivestimento su misura alta", marca: "Non specificata", codiciLEA: ["06.33.21.012 (x2)", "063391121 (x2)", "06.33.91.148 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Non specificata", patologie: "Deformità del piede"},
          { prodotto: "Scarpe di rivestimento su misura bassa con rialzo fino a 2 cm", marca: "Non specificata", codiciLEA: ["06.33.21.021 (x2)", "06.33.91.148 (x2)", "063391106 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Deformità del piede"},
          { prodotto: "Scarpe di rivestimento su misura alta con rialzo fino a 2 cm", marca: "Non specificata", codiciLEA: ["06.33.21.024 (x2)", "063391124 (x2)", "06.33.91.148 (x2)", "063391106 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Deformità del piede"},
          { prodotto: "Scarpe di rivestimento su misura alta con rialzo da 2 a 4 cm", marca: "Non specificata", codiciLEA: ["06.33.21.030 (x2)", "063391121 (x2)", "06.33.91.148 (x2)", "06.33.91.118 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "deformità del piede, eterometria arti inferiore"},
          { prodotto: "Scarpe di rivestimento su misura alta Con rialzo da 4 a 8 cm", marca: "Non specificata", codiciLEA: ["06.33.21.033 (x2)", "063391121 (x2)", "06.33.91.148 (x2)", "06.33.91.118 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "deformità del piede, eterometria arti inferiore"},
          { prodotto: "Scarpe di rivestimento su misura alta Con rialzo oltre gli 8 cm", marca: "Non specificata", codiciLEA: ["06.33.21.036 (x2)", "063391121 (x2)", "06.33.91.148 (x2)", "06.33.91.118 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "deformità del piede, eterometria arti inferiori"},
          { prodotto: "Calzature su misura per patologie complesse Piede equino, varo, supinato, addotto", marca: "Non specificata", codiciLEA: ["06.33.05.003 (x2)", "06.33.91.106 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Ortesi arto inferiori", patologie: "Non specificata"},
          { prodotto: "Calzatura su misura con avampiede bassa", marca: "Non specificata", codiciLEA: ["06.33.05.006 (x2)", "06.33.91.148 (x2)", "06.12.03.042 (x2)", "06.12.91.103 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Non specificata", patologie: "Non specificata"},
          { prodotto: "Calzatura su misura con avampiede alta", marca: "Non specificata", codiciLEA: ["06.33.05.009 (x2)", "063391121 (x2)", "06.33.91.148 (x2)", "06.12.03.042 (x2)", "06.12.91.103 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "Non specificata", patologie: "Non specificata"},
          { prodotto: "Protesi Provvisoria Modulare transtibiale", marca: "Non specificata", codiciLEA: ["06.24.09.033", "06.24.91.121", "062491239", "06.24.91.224", "06.24.91.242", "06.24.91.233"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi definitiva Modulare Transtibiale", marca: "Non specificata", codiciLEA: ["06.24.09.039", "06.24.91.224", "06.24.91.239", "06.24.91.242", "06.24.91.233", "062491121"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi modulare Transtibiale da bagno", marca: "Non specificata", codiciLEA: ["06.24.09.045", "06.24.91.224", "06.24.91.239", "06.24.91.242", "06.24.91.233", "06.24.91.121"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi modulare provvisoria Transfermorale", marca: "Non specificata", codiciLEA: ["06.24.15.030", "06.24.91.224 (x2)", "062491121", "06.24.91.330", "06.24.91.245", "06.24.91.324"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfemorale definitiva", marca: "Non specificata", codiciLEA: ["06.24.15.036", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio monocentrico...", marca: "Non specificata", codiciLEA: ["06.24.15.042", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio policentrico...", marca: "Non specificata", codiciLEA: ["06.24.15.048", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio idraulico o pneumatico...", marca: "Non specificata", codiciLEA: ["06.24.15.054", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio polifunzionale monocentrico a frizione...", marca: "Non specificata", codiciLEA: ["06.24.15.057", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio polifunzionale policentrico pneumatico...", marca: "Non specificata", codiciLEA: ["06.24.15.060", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio polifunzionale monocentrico con freno automatico...", marca: "Non specificata", codiciLEA: ["06.24.15.063", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Transfermorale Definitiva con invasatura con aderenza totale e tenuta pneumatica: ginocchio con bloccaggio manuale in acciaio...", marca: "Non specificata", codiciLEA: ["06.24.15.069", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi Modulare Definitiva transfemorale da bagno", marca: "Non specificata", codiciLEA: ["06.24.15.081", "06.24.91.224", "06.24.91.339", "06.24.91.330", "06.24.91.245", "06.24.91.324", "062491124", "062491106"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto inferiore", patologie: "Non specificata"},
          { prodotto: "Protesi estetica transradiale", marca: "Non specificata", codiciLEA: ["061809018 1413,20", "061891109 106,00", "061891115 197,50"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto superiore", patologie: "Non specificata"},
          { prodotto: "Protesi mioelettrica transradiale", marca: "Non specificata", codiciLEA: ["61809069", "061891109", "061891115"], tipoDispositivo: "Su Misura", categoriaOrtesi: "protesi arto superiore", patologie: "Non specificata"},
          { prodotto: "Tutore elastico S.El.Li per pollice dita escluse (Palmare)", marca: "Non specificata", codiciLEA: ["06.06.13.015", "06.06.91.106"], tipoDispositivo: "Su Misura", categoriaOrtesi: "arto superiore", patologie: "Paramorfismi e dismorfismi di tipo neurogeno e neuromuscolare, in presenza di un deficit di tipo posturale."},
          { prodotto: "Tutore Elastico S.EI.Li per polso con pollice e dita escluse (Palmare)", marca: "Non specificata", codiciLEA: ["06.06.13.015", "06.06.91.106 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "arto superiore", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li per avambraccio polso, mano e dita (Palmare)", marca: "Non specificata", codiciLEA: ["06.06.13.012", "06.06.91.106 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "arto superiore", patologie: "Non specificata"},
          { prodotto: "tutore elastico S. El. Li per gomito e avambraccio (gomitiera)", marca: "Non specificata", codiciLEA: ["06.06.12.003"], tipoDispositivo: "Su Misura", categoriaOrtesi: "arto superiore", patologie: "Non specificata"},
          { prodotto: "tutore elastico S. El. Li per avambraccio polso mano (tutore avambraccio mano)", marca: "Non specificata", codiciLEA: ["06.06.13.012", "06.06.91.106 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "arto superiore", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li di tronco con spalle incluse (tutore di tronco)", marca: "Non specificata", codiciLEA: ["06.03.18.033"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi di tronco", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li di tronco con spalle incluse e prolungamento sacro ischiatica (tutore di tronco)", marca: "Non specificata", codiciLEA: ["06.03.18.033", "06.03.91.715"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi di tronco", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li di tronco con presa scapolo-omerale (tutore di tronco)", marca: "Non specificata", codiciLEA: ["06.03.18.033", "06.03.91.721 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi di tronco", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li di tronco con presa scapolo-omerale e prolungamento sacro ischiatico (tutore di tronco)", marca: "Non specificata", codiciLEA: ["06.03.18.033", "06.03.91.715", "06.03.91.721 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi di tronco", patologie: "Non specificata"},
          { prodotto: "Tutore elastico S. El. Li di tronco con prolungamento alle cosce (tutore di tronco)", marca: "Non specificata", codiciLEA: ["06.03.18.033", "06.03.91.715", "06.03.91.718"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi di tronco", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li di tronco con presa scapolo-omerale e prolungamento sacro ischiatico (con prolungamento alle cosce)", marca: "Non specificata", codiciLEA: ["06.03.18.033", "06.03.91.715", "06.03.91.718", "06.03.91.724 (x2)"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi di tronco", patologie: "Non specificata"},
          { prodotto: "Tutore Elastico S. El. Li abduttore per bacino e cosce (tutore bacino)", marca: "Non specificata", codiciLEA: ["06.12.15.009"], tipoDispositivo: "Su Misura", categoriaOrtesi: "ortesi d'anca", patologie: "Non specificata"}
        ];

        // --- Elementi DOM e resto dello script (invariato)
        const searchInputEl = document.getElementById('searchInput');
        const [devicesContainerSerieEl, devicesContainerSuMisuraEl] = [document.getElementById('devicesContainerSerie'), document.getElementById('devicesContainerSuMisura')];
        const [noResultsSerieEl, noResultsSuMisuraEl, noResultsGlobalEl] = [document.getElementById('noResultsSerie'), document.getElementById('noResultsSuMisura'), document.getElementById('noResultsGlobal')];
        const [toggleSerieEl, toggleSuMisuraEl] = [document.getElementById('toggleSerie'), document.getElementById('toggleSuMisura')];
        const [devicesContainerSerieWrapperEl, devicesContainerSuMisuraWrapperEl] = [document.getElementById('devicesContainerSerieWrapper'), document.getElementById('devicesContainerSuMisuraWrapper')];
        const [sortButtonSerie, sortButtonSuMisura] = [document.getElementById('sortButtonSerie'), document.getElementById('sortButtonSuMisura')];
        const [sortDropdownSerie, sortDropdownSuMisura] = [document.getElementById('sortDropdownSerie'), document.getElementById('sortDropdownSuMisura')];
        const [exportDataBtn, importDataBtn, importFileIn] = [document.getElementById('exportDataButton'), document.getElementById('importDataButton'), document.getElementById('importFileInput')];
        const [modalEl, modalTitleEl, modalTextEl, cancelActionBtn, confirmActionBtn] = [document.getElementById('confirmationModal'), document.getElementById('modalTitle'), document.getElementById('modalText'), document.getElementById('cancelActionButton'), document.getElementById('confirmActionButton')];

        let confirmationCallback = null;

        async function initialize() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await seedDatabaseIfNeeded();
                        listenForDeviceChanges();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Errore di inizializzazione Firebase:", error);
                document.body.innerHTML = "Errore critico durante l'inizializzazione dell'applicazione. Controlla la console.";
            }
        }

        async function seedDatabaseIfNeeded() {
            const q = query(collection(db, devicesCollectionPath));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                console.log("Database vuoto, procedo con il popolamento iniziale...");
                const batch = writeBatch(db);
                initialDevicesData.forEach(deviceData => {
                    const formattedCodici = (deviceData.codiciLEA || []).map(codeStr => {
                        const parts = codeStr.split(' ');
                        const codice = parts[0];
                        const prezzo = parts.slice(1).join(' ');
                        return { codice: codice || "", descrizione: "", prezzo: prezzo || "" };
                    });
                    const newDevice = { ...deviceData, codici: formattedCodici };
                    delete newDevice.codiciLEA;
                    const newDocRef = doc(collection(db, devicesCollectionPath));
                    batch.set(newDocRef, newDevice);
                });
                await batch.commit();
                console.log("Popolamento iniziale completato.");
            }
        }
        
        function listenForDeviceChanges() {
            const q = query(collection(db, devicesCollectionPath));
            onSnapshot(q, (snapshot) => {
                allDevicesFromDB = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayDevices(allDevicesFromDB, searchInputEl.value);
            });
        }
        
        function highlightText(text, query) {
            if (!text) return '';
            if (!query || query.length < 1) return text;
            try {
                const sanitizedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${sanitizedQuery})`, 'gi');
                return text.replace(regex, `<span class="highlight">$1</span>`);
            } catch (e) { console.error("Regex Error:", e); return text; }
        }

        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card bg-white p-5 rounded-xl shadow-lg hover:shadow-xl border border-gray-200';
            card.dataset.deviceId = device.id;
            
            const viewModeHtml = `
                <div class="view-mode-field">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2">${highlightText(device.prodotto, searchInputEl.value)}</h3>
                    <p class="text-sm text-sky-600 font-semibold mb-1">Marca: ${highlightText(device.marca, searchInputEl.value)}</p>
                    <p class="text-sm text-gray-500 mt-1">Categoria: ${highlightText(device.categoriaOrtesi, searchInputEl.value)}</p>
                    <p class="text-sm text-gray-500 mt-2">Patologie: ${highlightText(device.patologie, searchInputEl.value)}</p>
                    <p class="text-sm sm:text-md font-medium text-gray-700 mt-3 mb-1">Codici Nuovi LEA:</p>
                    <ul class="list-disc list-inside space-y-1 text-xs sm:text-sm">
                        ${(device.codici || []).map(c => `<li><strong>${highlightText(c.codice, searchInputEl.value)}</strong> (${c.prezzo ? highlightText(c.prezzo, searchInputEl.value) + ' €' : 'N/P'}): ${highlightText(c.descrizione || 'N/A', searchInputEl.value)}</li>`).join('')}
                    </ul>
                </div>`;

            const editModeHtml = `
                <div class="edit-mode-field flex-col space-y-2">
                    <input type="text" value="${device.prodotto}" class="edit-prodotto w-full p-2 border rounded" placeholder="Nome Prodotto">
                    <input type="text" value="${device.marca}" class="edit-marca w-full p-2 border rounded" placeholder="Marca">
                    <input type="text" value="${device.categoriaOrtesi}" class="edit-categoria w-full p-2 border rounded" placeholder="Categoria">
                    <textarea class="edit-patologie w-full p-2 border rounded" placeholder="Patologie">${device.patologie}</textarea>
                    <h4 class="font-semibold mt-2">Codici LEA</h4>
                    <div class="edit-codes-container space-y-2 max-h-48 overflow-y-auto pr-2">
                    ${(device.codici || []).map(c => `
                        <div class="code-row space-y-1 border-t pt-2 mt-2">
                            <div class="grid grid-cols-[1fr_120px_auto] gap-2 items-center">
                                <input type="text" value="${c.codice || ''}" class="edit-codice-val p-1 border rounded" placeholder="Codice LEA">
                                <input type="text" value="${c.prezzo || ''}" class="edit-prezzo-val p-1 border rounded" placeholder="Prezzo (€)">
                                <button class="remove-code-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <input type="text" value="${c.descrizione || ''}" class="edit-desc-val w-full p-1 border rounded" placeholder="Descrizione del codice">
                        </div>`).join('')
                    }
                    </div>
                    <button class="add-code-btn mt-2 text-sm text-sky-600 hover:text-sky-800">+ Aggiungi Codice</button>
                </div>`;
            
            const controlsHtml = `
                <div class="mt-4 flex justify-between items-center">
                    <div class="view-mode-field">
                        <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">Modifica</button>
                    </div>
                    <div class="edit-mode-controls space-x-2">
                        <button class="save-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">Salva</button>
                        <button class="cancel-btn bg-gray-400 text-white px-3 py-1 rounded hover:bg-gray-500 text-sm">Annulla</button>
                    </div>
                    <button class="delete-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `;

            card.innerHTML = `<div class="flex-grow overflow-y-auto pr-2">${viewModeHtml}${editModeHtml}</div>${controlsHtml}`;
            addCardEventListeners(card, device);
            return card;
        }

        function displayDevices(devices, query = "") {
            const lowerCaseQuery = query.toLowerCase().trim();
            
            const filteredDevices = devices.filter(device => {
                const prodottoMatch = device.prodotto && device.prodotto.toLowerCase().includes(lowerCaseQuery);
                const marcaMatch = device.marca && device.marca.toLowerCase().includes(lowerCaseQuery);
                const codiciMatch = (device.codici || []).some(c => (c.codice && c.codice.toLowerCase().includes(lowerCaseQuery)) || (c.descrizione && c.descrizione.toLowerCase().includes(lowerCaseQuery)) || (c.prezzo && c.prezzo.toLowerCase().includes(lowerCaseQuery)));
                const tipoMatch = device.tipoDispositivo && device.tipoDispositivo.toLowerCase().includes(lowerCaseQuery);
                const categoriaMatch = device.categoriaOrtesi && device.categoriaOrtesi.toLowerCase().includes(lowerCaseQuery);
                const patologieMatch = device.patologie && device.patologie.toLowerCase().includes(lowerCaseQuery);
                return prodottoMatch || marcaMatch || codiciMatch || tipoMatch || categoriaMatch || patologieMatch;
            });

            let serieDevices = filteredDevices.filter(d => d.tipoDispositivo === "Di Serie");
            let suMisuraDevices = filteredDevices.filter(d => d.tipoDispositivo === "Su Misura");

            const sortFn = (a, b, key) => (a[key] || '').localeCompare(b[key] || '', 'it', { sensitivity: 'base' });
            serieDevices.sort((a,b) => sortFn(a, b, currentSort.serie));
            suMisuraDevices.sort((a,b) => sortFn(a, b, currentSort.suMisura));

            devicesContainerSerieEl.innerHTML = '';
            devicesContainerSuMisuraEl.innerHTML = '';

            serieDevices.forEach(device => devicesContainerSerieEl.appendChild(createDeviceCard(device)));
            suMisuraDevices.forEach(device => devicesContainerSuMisuraEl.appendChild(createDeviceCard(device)));
            
            if (query) {
                if (serieDevices.length > 0) openSection(toggleSerieEl, devicesContainerSerieWrapperEl);
                if (suMisuraDevices.length > 0) openSection(toggleSuMisuraEl, devicesContainerSuMisuraWrapperEl);
            }

            noResultsSerieEl.classList.toggle('hidden', serieDevices.length > 0 || query === "");
            noResultsSuMisuraEl.classList.toggle('hidden', suMisuraDevices.length > 0 || query === "");
            noResultsGlobalEl.classList.toggle('hidden', filteredDevices.length > 0 || query === "");
        }
        
        function addCardEventListeners(card, device) {
            const editBtn = card.querySelector('.edit-btn');
            const saveBtn = card.querySelector('.save-btn');
            const cancelBtn = card.querySelector('.cancel-btn');
            const deleteBtn = card.querySelector('.delete-btn');
            const addCodeBtn = card.querySelector('.add-code-btn');

            editBtn.addEventListener('click', () => card.classList.add('card-editing'));
            
            cancelBtn.addEventListener('click', () => card.classList.remove('card-editing'));
            
            saveBtn.addEventListener('click', async () => {
                const updatedDevice = {
                    prodotto: card.querySelector('.edit-prodotto').value,
                    marca: card.querySelector('.edit-marca').value,
                    categoriaOrtesi: card.querySelector('.edit-categoria').value,
                    patologie: card.querySelector('.edit-patologie').value,
                    tipoDispositivo: device.tipoDispositivo,
                    codici: Array.from(card.querySelectorAll('.code-row')).map(row => ({
                        codice: row.querySelector('.edit-codice-val').value,
                        prezzo: row.querySelector('.edit-prezzo-val').value,
                        descrizione: row.querySelector('.edit-desc-val').value,
                    }))
                };
                
                const docRef = doc(db, devicesCollectionPath, device.id);
                await updateDoc(docRef, updatedDevice);
                card.classList.remove('card-editing');
            });
            
            deleteBtn.addEventListener('click', () => {
                openConfirmationModal('Conferma Eliminazione', 'Sei sicuro di voler eliminare questo dispositivo?', () => {
                    deleteDoc(doc(db, devicesCollectionPath, device.id));
                });
            });
            
            addCodeBtn.addEventListener('click', () => {
                const codesContainer = card.querySelector('.edit-codes-container');
                const codeRow = document.createElement('div');
                codeRow.className = "code-row space-y-1 border-t pt-2 mt-2";
                codeRow.innerHTML = `
                    <div class="grid grid-cols-[1fr,120px,auto] gap-2 items-center">
                        <input type="text" class="edit-codice-val p-1 border rounded" placeholder="Codice LEA">
                        <input type="text" class="edit-prezzo-val p-1 border rounded" placeholder="Prezzo (€)">
                        <button class="remove-code-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <input type="text" class="edit-desc-val w-full p-1 border rounded" placeholder="Descrizione del codice">`;
                codesContainer.appendChild(codeRow);
                codeRow.querySelector('.remove-code-btn').addEventListener('click', (e) => e.currentTarget.closest('.code-row').remove());
            });

            card.querySelectorAll('.remove-code-btn').forEach(btn => {
                btn.addEventListener('click', (e) => e.currentTarget.closest('.code-row').remove());
            });
        }
        
        async function handleAddNewDevice(tipo) {
            const newDevice = {
                prodotto: "Nuovo Dispositivo",
                marca: "",
                categoriaOrtesi: "",
                patologie: "",
                codici: [{ codice: "", descrizione: "", prezzo: "" }],
                tipoDispositivo: tipo
            };
            await addDoc(collection(db, devicesCollectionPath), newDevice);
        }

        function openConfirmationModal(title, text, callback) {
            modalTitleEl.textContent = title;
            modalTextEl.textContent = text;
            modalEl.style.display = 'flex';
            confirmationCallback = callback;
        }

        function closeConfirmationModal() {
            modalEl.style.display = 'none';
            confirmationCallback = null;
        }
        
        function openSection(toggleElement, containerWrapperElement) {
            if (containerWrapperElement.classList.contains('hidden')) {
                containerWrapperElement.classList.remove('hidden');
                toggleElement.classList.remove('collapsed');
            }
        }

        function setupAdvancedTools() {
            const setupSort = (btn, dropdown, type) => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sortDropdownSerie.style.display = 'none';
                    sortDropdownSuMisura.style.display = 'none';
                    dropdown.style.display = 'block';
                });
                dropdown.addEventListener('click', (e) => {
                    if (e.target.classList.contains('sort-option')) {
                        currentSort[type] = e.target.dataset.sortBy;
                        displayDevices(allDevicesFromDB, searchInputEl.value);
                        dropdown.style.display = 'none';
                    }
                });
            };
            setupSort(sortButtonSerie, sortDropdownSerie, 'serie');
            setupSort(sortButtonSuMisura, sortDropdownSuMisura, 'suMisura');
            document.addEventListener('click', () => {
                sortDropdownSerie.style.display = 'none';
                sortDropdownSuMisura.style.display = 'none';
            });

            exportDataBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(allDevicesFromDB, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `lea_backup_${new Date().toISOString().slice(0,10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });

            importDataBtn.addEventListener('click', () => importFileIn.click());
            importFileIn.addEventListener('change', (event) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    openConfirmationModal(
                        'Conferma Importazione Dati',
                        'ATTENZIONE: Stai per sovrascrivere tutti i dati esistenti. Questa azione è irreversibile. Procedere?',
                        async () => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (!Array.isArray(importedData)) throw new Error("Il file non è un array valido.");
                                const deleteBatch = writeBatch(db);
                                allDevicesFromDB.forEach(device => {
                                    deleteBatch.delete(doc(db, devicesCollectionPath, device.id));
                                });
                                await deleteBatch.commit();
                                const addBatch = writeBatch(db);
                                importedData.forEach(device => {
                                    const { id, ...deviceData } = device;
                                    const newDocRef = doc(collection(db, devicesCollectionPath));
                                    addBatch.set(newDocRef, deviceData);
                                });
                                await addBatch.commit();
                                console.log("Dati importati con successo.");
                            } catch (err) {
                                console.error("Errore durante l'importazione:", err);
                                alert("Errore: Il file non è valido o il formato non è corretto.");
                            }
                        }
                    );
                };
                reader.readAsText(event.target.files[0]);
                event.target.value = '';
            });
        }
        
        function setupCollapsibleSections() {
            const toggleSection = (toggleElement, containerWrapperElement) => {
                containerWrapperElement.classList.toggle('hidden');
                toggleElement.classList.toggle('collapsed');
            };
            toggleSerieEl.addEventListener('click', () => toggleSection(toggleSerieEl, devicesContainerSerieWrapperEl));
            toggleSuMisuraEl.addEventListener('click', () => toggleSection(toggleSuMisuraEl, devicesContainerSuMisuraWrapperEl));

            if (!devicesContainerSerieWrapperEl.classList.contains('hidden')) {
                toggleSection(toggleSerieEl, devicesContainerSerieWrapperEl);
            }
            if (!devicesContainerSuMisuraWrapperEl.classList.contains('hidden')) {
                toggleSection(toggleSuMisuraEl, devicesContainerSuMisuraWrapperEl);
            }
        }
        
        document.getElementById('addDeviceSerie').addEventListener('click', () => handleAddNewDevice('Di Serie'));
        document.getElementById('addDeviceSuMisura').addEventListener('click', () => handleAddNewDevice('Su Misura'));
        searchInputEl.addEventListener('input', () => displayDevices(allDevicesFromDB, searchInputEl.value));
        cancelActionBtn.addEventListener('click', closeConfirmationModal);
        confirmActionBtn.addEventListener('click', () => {
            if (confirmationCallback) confirmationCallback();
            closeConfirmationModal();
        });

        initialize();
        setupCollapsibleSections();
        setupAdvancedTools();
    </script>
</body>
</html>
