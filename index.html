<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Codici LEA (Cloud)</title>
    <!-- Librerie esterne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .highlight { background-color: #fef08a; font-weight: bold; }
        .section-title { border-bottom: 2px solid #0ea5e9; padding-bottom: 8px; margin-bottom: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-title .arrow { transition: transform 0.3s ease; }
        .section-title.collapsed .arrow { transform: rotate(-90deg); }
        
        .macro-category-title {
            background-color: #f8fafc; padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-size: 1.125rem; font-weight: 600; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; margin-top: 1rem; border: 1px solid #e5e7eb;
        }
        .macro-category-title .arrow { transition: transform 0.3s ease; }
        .macro-category-title.collapsed .arrow { transform: rotate(-90deg); }
        .macro-category-content {
            padding-top: 1rem; transition: max-height 0.4s ease-in-out;
            overflow: hidden; max-height: 5000px;
        }
        .macro-category-content.hidden { max-height: 0; padding-top: 0; }

        .device-list-item {
            cursor: pointer; background-color: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s ease-in-out;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .device-list-item:hover {
            transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); border-color: #38bdf8;
        }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); display: none; 
            justify-content: center; align-items: center; 
            transition: opacity 0.3s ease;
        }
        #deviceModal, #categoriesModal, #exportOptionsModal { z-index: 1000; }
        #confirmationModal { z-index: 1010; }
        #notificationModal { z-index: 1020; }

        .modal-box {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 800px; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        #deviceModalBox { height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem; flex-shrink: 0; }
        .modal-header h3 { font-size: 1.5rem; font-weight: 600; }
        .modal-header .close-button { font-size: 1.5rem; color: #9ca3af; cursor: pointer; transition: color 0.2s; }
        .modal-header .close-button:hover { color: #1f2937; }
        .modal-body { flex-grow: 1; overflow-y: auto; min-height: 0; padding-right: 1rem; }
        .modal-footer { border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; }
        
        .sort-dropdown { display: none; position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; right: 0; min-width: 180px; }
        .sort-dropdown button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; }
        .sort-dropdown button:hover { background-color: #f3f4f6; }

        #confirmationModal .modal-box, #notificationModal .modal-box, #categoriesModal .modal-box, #exportOptionsModal .modal-box { max-width: 500px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        
        .category-item-input {
            background-color: transparent; border-color: transparent;
            transition: all 0.2s ease;
        }
        .category-item-input:read-only { pointer-events: none; }
        .category-item-input.editing { background-color: white; border-color: #cbd5e1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Gestore Codici LEA</h1>
            <p class="text-gray-600 mt-2">I tuoi dati sono ora salvati e sincronizzati sul cloud.</p>
        </header>

        <div class="mb-4 p-4 bg-white rounded-lg shadow">
            <h3 class="font-semibold text-lg mb-3">Filtri di Ricerca</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700">Ricerca Testuale</label>
                    <input type="text" id="searchInput"
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"
                           placeholder="Cerca prodotto, marca, codice...">
                </div>
                <div>
                     <label for="filterMacroCategory" class="block text-sm font-medium text-gray-700">Macro Categoria</label>
                     <select id="filterMacroCategory" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        <option value="">Tutte le Macro Categorie</option>
                     </select>
                </div>
                 <div>
                     <label for="filterMarca" class="block text-sm font-medium text-gray-700">Marca</label>
                     <select id="filterMarca" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                         <option value="">Tutte le Marche</option>
                     </select>
                </div>
            </div>
             <div class="mt-4 text-right">
                <button id="resetFiltersBtn" class="text-sm text-gray-600 hover:text-sky-600 hover:underline">Resetta Filtri</button>
            </div>
        </div>


        <section id="sectionSerieWrapper" class="mb-12">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="toggleSerie" class="text-2xl font-semibold text-sky-700 section-title flex-grow">
                    <span>Ortesi di Serie</span>
                    <span class="arrow text-sky-700">&#9660;</span>
                </h2>
                <div class="relative">
                    <button id="sortButtonSerie" class="ml-4 text-gray-500 hover:text-sky-600 p-2 rounded-full" aria-label="Ordina dispositivi di serie"><i class="fas fa-gear"></i></button>
                    <div id="sortDropdownSerie" class="sort-dropdown">
                        <button class="sort-option" data-sort-by="prodotto">Ordina per Prodotto (A-Z)</button>
                        <button class="sort-option" data-sort-by="marca">Ordina per Marca (A-Z)</button>
                    </div>
                </div>
                <button id="addDeviceSerie" class="ml-2 bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors"><i class="fas fa-plus mr-2"></i>Aggiungi</button>
            </div>
            <div id="devicesListSerie" class="space-y-4"></div>
            <p id="noResultsSerie" class="hidden text-center text-gray-500 mt-6">Nessun dispositivo "Di Serie" trovato.</p>
        </section>

        <section id="sectionSuMisuraWrapper" class="mb-12">
             <div class="flex justify-between items-center mb-4">
                <h2 id="toggleSuMisura" class="text-2xl font-semibold text-teal-700 section-title flex-grow">
                    <span>Ortesi su Misura</span>
                    <span class="arrow text-teal-700">&#9660;</span>
                </h2>
                 <div class="relative">
                    <button id="sortButtonSuMisura" class="ml-4 text-gray-500 hover:text-teal-600 p-2 rounded-full" aria-label="Ordina dispositivi su misura"><i class="fas fa-gear"></i></button>
                    <div id="sortDropdownSuMisura" class="sort-dropdown">
                        <button class="sort-option" data-sort-by="prodotto">Ordina per Prodotto (A-Z)</button>
                        <button class="sort-option" data-sort-by="marca">Ordina per Marca (A-Z)</button>
                    </div>
                </div>
                <button id="addDeviceSuMisura" class="ml-2 bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition-colors"><i class="fas fa-plus mr-2"></i>Aggiungi</button>
            </div>
            <div id="devicesListSuMisura" class="space-y-4"></div>
            <p id="noResultsSuMisura" class="hidden text-center text-gray-500 mt-6">Nessun dispositivo "Su Misura" trovato.</p>
        </section>
        
        <div id="noResultsGlobal" class="hidden text-center text-gray-500 mt-10">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="mt-2 text-xl">Nessun risultato trovato.</p>
            <p>Prova a modificare i termini di ricerca.</p>
        </div>

        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Strumenti Avanzati</h3>
            <div class="flex justify-center flex-wrap gap-4">
                <button id="manageCategoriesButton" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-tags mr-2"></i>Gestisci Categorie</button>
                <button id="exportDataButton" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-download mr-2"></i>Esporta JSON</button>
                <button id="exportPdfButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"><i class="fas fa-file-pdf mr-2"></i>Esporta PDF</button>
                <button id="exportCsvButton" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"><i class="fas fa-file-csv mr-2"></i>Esporta CSV</button>
                <button id="importDataButton" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors"><i class="fas fa-upload mr-2"></i>Importa JSON</button>
                <input type="file" id="importFileInput" class="hidden" accept=".json">
            </div>
        </footer>
    </div>
    
    <!-- Modali -->
    <div id="deviceModal" class="modal-overlay">
        <div id="deviceModalBox" class="modal-box">
             <div class="modal-header"></div><div class="modal-body"></div><div class="modal-footer"></div>
        </div>
    </div>
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="confirmationModalTitle" class="text-xl font-semibold text-gray-800">Conferma Azione</h3>
            <p id="confirmationModalText" class="text-gray-600 my-4">Sei sicuro di voler procedere?</p>
            <div class="modal-actions">
                <button id="cancelActionButton" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Annulla</button>
                <button id="confirmActionButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Conferma</button>
            </div>
        </div>
    </div>
    <div id="notificationModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="notificationModalTitle" class="text-xl font-semibold text-gray-800">Notifica</h3>
            <p id="notificationModalText" class="text-gray-600 my-4"></p>
            <div class="modal-actions">
                <button id="notificationOkButton" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600">OK</button>
            </div>
        </div>
    </div>
    <div id="categoriesModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><h3 class="text-xl font-semibold">Gestisci Macro-Categorie</h3><button class="close-button" aria-label="Chiudi">&times;</button></div>
            <div class="modal-body">
                <ul id="categoryList" class="space-y-2"></ul>
                <div class="mt-4 pt-4 border-t"><label for="newCategoryInput" class="font-semibold text-gray-700">Aggiungi Nuova Categoria</label><div class="flex items-center space-x-2 mt-2"><input type="text" id="newCategoryInput" placeholder="Nome nuova categoria..." class="w-full p-2 border rounded"><button id="addCategoryButton" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors">Aggiungi</button></div></div>
            </div>
            <div class="modal-footer"><div class="flex justify-end"><button class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 close-button">Chiudi</button></div></div>
        </div>
    </div>
    <div id="exportOptionsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><h3 class="text-xl font-semibold">Opzioni Esportazione PDF</h3><button class="close-button" aria-label="Chiudi">&times;</button></div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Tipi di Dispositivo</h4>
                            <div class="space-y-1"><label class="flex items-center"><input type="checkbox" id="exportTipoSerie" name="exportTipo" value="Di Serie" checked class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500"><span class="ml-2 text-gray-700">Ortesi di Serie</span></label><label class="flex items-center"><input type="checkbox" id="exportTipoSuMisura" name="exportTipo" value="Su Misura" checked class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500"><span class="ml-2 text-gray-700">Ortesi su Misura</span></label></div>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-gray-700">Macro Categorie</h4>
                                <button type="button" id="toggleAllCategoriesBtn" class="text-xs text-sky-600 hover:underline">Deseleziona tutto</button>
                            </div>
                            <div id="exportCategoriesList" class="space-y-1 max-h-40 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-actions">
                <button class="close-button bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Annulla</button>
                <button id="generatePdfBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Genera PDF</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // CONFIGURAZIONE FIREBASE (INSERITA DA TE)
        const firebaseConfig = {
          apiKey: "AIzaSyDW0Bl90TBc-MkRfK7aF4tpe3TxqWjQpuU",
          authDomain: "codifiche-lea.firebaseapp.com",
          projectId: "codifiche-lea",
          storageBucket: "codifiche-lea.appspot.com",
          messagingSenderId: "416568271465",
          appId: "1:416568271465:web:c309850e9a2608fe7938f8"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            let allDevices = [];
            let currentSort = { serie: 'prodotto', suMisura: 'prodotto' };
            let macroCategoriesList = [];
            let unsubscribeDevices = null;
            let unsubscribeCategories = null;
            
            // Riferimenti al DOM (invariati)
            const searchInputEl = document.getElementById('searchInput');
            const filterMacroCategoryEl = document.getElementById('filterMacroCategory');
            const filterMarcaEl = document.getElementById('filterMarca');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const devicesListSerieEl = document.getElementById('devicesListSerie');
            const devicesListSuMisuraEl = document.getElementById('devicesListSuMisura');
            const noResultsSerieEl = document.getElementById('noResultsSerie');
            const noResultsSuMisuraEl = document.getElementById('noResultsSuMisura');
            const noResultsGlobalEl = document.getElementById('noResultsGlobal');
            const toggleSerieEl = document.getElementById('toggleSerie');
            const toggleSuMisuraEl = document.getElementById('toggleSuMisura');
            const sortButtonSerie = document.getElementById('sortButtonSerie');
            const sortButtonSuMisura = document.getElementById('sortButtonSuMisura');
            const sortDropdownSerie = document.getElementById('sortDropdownSerie');
            const sortDropdownSuMisura = document.getElementById('sortDropdownSuMisura');
            const exportDataBtn = document.getElementById('exportDataButton');
            const importDataBtn = document.getElementById('importDataButton');
            const importFileIn = document.getElementById('importFileInput');
            const manageCategoriesBtn = document.getElementById('manageCategoriesButton');
            const exportPdfBtn = document.getElementById('exportPdfButton');
            const exportCsvBtn = document.getElementById('exportCsvButton');
            const deviceModalEl = document.getElementById('deviceModal');
            const deviceModalBoxEl = document.getElementById('deviceModalBox');
            const confirmationModalEl = document.getElementById('confirmationModal');
            const confirmationModalTitleEl = document.getElementById('confirmationModalTitle');
            const confirmationModalTextEl = document.getElementById('confirmationModalText');
            const cancelActionBtn = document.getElementById('cancelActionButton');
            const confirmActionBtn = document.getElementById('confirmActionButton');
            const notificationModalEl = document.getElementById('notificationModal');
            const notificationModalTextEl = document.getElementById('notificationModalText');
            const notificationOkButton = document.getElementById('notificationOkButton');
            const categoriesModalEl = document.getElementById('categoriesModal');
            const exportOptionsModalEl = document.getElementById('exportOptionsModal');
            let confirmationCallback = null;

            // Funzioni Utilità (invariate)
            function openModal(modalElement) { modalElement.classList.add('visible'); }
            function closeModal(modalElement) { modalElement.classList.remove('visible'); }
            function showNotification(message) { notificationModalTextEl.textContent = message; openModal(notificationModalEl); }
            function openConfirmationModal(title, text, callback) { confirmationModalTitleEl.textContent = title; confirmationModalTextEl.textContent = text; confirmationCallback = callback; openModal(confirmationModalEl); }
            function closeConfirmationModal() { closeModal(confirmationModalEl); confirmationCallback = null; }
            function highlightText(text, query) { if (!text) return ''; if (!query || query.length < 1) return text; const sanitizedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`(${sanitizedQuery})`, 'gi'); return text.replace(regex, `<span class="highlight">$1</span>`); }
            function createDeviceListItem(device, query) { const item = document.createElement('div'); item.className = 'device-list-item'; item.innerHTML = `<div class="flex-grow"><div class="font-semibold text-gray-800 truncate">${highlightText(device.prodotto, query)}</div><div class="text-sm text-gray-500">${highlightText(device.marca, query)}</div></div><div class="text-xs text-gray-400 mt-3 pt-2 border-t border-gray-100">${highlightText(device.categoriaOrtesi, query) || 'Senza categoria'}</div>`; item.addEventListener('click', () => openDeviceModal(device)); return item; }
            
            // --- Funzioni di Visualizzazione e Filtro (leggermente modificate) ---
            function populateFilters() {
                filterMacroCategoryEl.innerHTML = '<option value="">Tutte le Macro Categorie</option>';
                [...macroCategoriesList].sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filterMacroCategoryEl.appendChild(option);
                });

                const marche = [...new Set(allDevices.map(d => d.marca).filter(Boolean))].sort();
                filterMarcaEl.innerHTML = '<option value="">Tutte le Marche</option>';
                marche.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca;
                    option.textContent = marca;
                    filterMarcaEl.appendChild(option);
                });
            }

            function updateAndDisplayLists() {
                const query = searchInputEl.value.toLowerCase().trim();
                const selectedMacroCategory = filterMacroCategoryEl.value;
                const selectedMarca = filterMarcaEl.value;

                let filteredDevices = allDevices;
                if(selectedMacroCategory) { filteredDevices = filteredDevices.filter(d => d.macroCategoria === selectedMacroCategory); }
                if(selectedMarca) { filteredDevices = filteredDevices.filter(d => d.marca === selectedMarca); }
                if(query) { filteredDevices = filteredDevices.filter(device => { const searchString = [device.macroCategoria, device.prodotto, device.marca, device.categoriaOrtesi, device.patologie, ...(device.codici || []).map(c => `${c.codice} ${c.descrizione}`)].join(' ').toLowerCase(); return searchString.includes(query); }); }

                const sortFn = (a, b, key) => (a[key] || '').localeCompare(b[key] || '', 'it', { sensitivity: 'base' });
                const serieDevices = filteredDevices.filter(d => d.tipoDispositivo === "Di Serie").sort((a,b) => sortFn(a, b, currentSort.serie));
                const suMisuraDevices = filteredDevices.filter(d => d.tipoDispositivo === "Su Misura").sort((a,b) => sortFn(a, b, currentSort.suMisura));
                renderGroupedList(devicesListSerieEl, serieDevices, query);
                renderGroupedList(devicesListSuMisuraEl, suMisuraDevices, query);
                noResultsSerieEl.classList.toggle('hidden', serieDevices.length > 0);
                noResultsSuMisuraEl.classList.toggle('hidden', suMisuraDevices.length > 0);
                noResultsGlobalEl.classList.toggle('hidden', filteredDevices.length > 0);
            }
            function renderGroupedList(container, devices, query) { container.innerHTML = ''; const isSearching = query.length > 0 || filterMacroCategoryEl.value || filterMarcaEl.value; const grouped = devices.reduce((acc, device) => { const key = device.macroCategoria || 'Senza Categoria'; if (!acc[key]) { acc[key] = []; } acc[key].push(device); return acc; }, {}); const sortedMacroCategories = Object.keys(grouped).sort((a,b) => a.localeCompare(b)); sortedMacroCategories.forEach(macroCat => { const groupContainer = document.createElement('div'); const title = document.createElement('h3'); title.className = `macro-category-title ${!isSearching ? 'collapsed' : ''}`; title.innerHTML = `<span>${macroCat}</span> <span class="arrow text-gray-500">&#9660;</span>`; const contentGrid = document.createElement('div'); contentGrid.className = `macro-category-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 ${!isSearching ? 'hidden' : ''}`; grouped[macroCat].forEach(device => contentGrid.appendChild(createDeviceListItem(device, query))); title.addEventListener('click', () => { title.classList.toggle('collapsed'); contentGrid.classList.toggle('hidden'); }); groupContainer.appendChild(title); groupContainer.appendChild(contentGrid); container.appendChild(groupContainer); }); }
            
            // --- Logica Modale Dispositivo con Calcoli ---
            function updateCodeTotals(modalBoxEl) { let grandTotal = 0; const codeRows = modalBoxEl.querySelectorAll('.code-row'); codeRows.forEach(row => { const prezzoInput = row.querySelector('.edit-prezzo-val'); const quantitaInput = row.querySelector('.edit-quantita-val'); const subtotalEl = row.querySelector('.subtotal-display'); const prezzoString = (prezzoInput.value || '0').replace(',', '.'); const prezzo = parseFloat(prezzoString) || 0; const quantita = parseInt(quantitaInput.value, 10) || 1; const subtotal = prezzo * quantita; if(subtotalEl) { subtotalEl.textContent = `Subtotale: ${subtotal.toFixed(2).replace('.', ',')} €`; } grandTotal += subtotal; }); const grandTotalEl = modalBoxEl.querySelector('#grand-total-display'); if (grandTotalEl) { grandTotalEl.textContent = `Totale Complessivo: ${grandTotal.toFixed(2).replace('.', ',')} €`; } }
            
            // --- Funzioni CRUD con Firebase ---
            async function handleSaveDevice(device, isNew) {
                const modalBox = deviceModalBoxEl;
                const updatedData = { 
                    macroCategoria: modalBox.querySelector('.edit-macrocategoria').value, 
                    prodotto: modalBox.querySelector('.edit-prodotto').value, 
                    marca: modalBox.querySelector('.edit-marca').value, 
                    categoriaOrtesi: modalBox.querySelector('.edit-categoria').value, 
                    patologie: modalBox.querySelector('.edit-patologie').value, 
                    note: modalBox.querySelector('.edit-note').value, 
                    tipoDispositivo: device.tipoDispositivo, 
                    codici: Array.from(modalBox.querySelectorAll('.code-row')).map(row => ({ 
                        codice: row.querySelector('.edit-codice-val').value.trim(), 
                        prezzo: row.querySelector('.edit-prezzo-val').value.trim(), 
                        quantita: parseInt(row.querySelector('.edit-quantita-val').value, 10) || 1, 
                        descrizione: row.querySelector('.edit-desc-val').value.trim(), 
                    })).filter(c => c.codice) 
                };

                try {
                    if (isNew) {
                        await addDoc(collection(db, "devices"), updatedData);
                    } else {
                        await updateDoc(doc(db, "devices", device.id), updatedData);
                    }
                    closeModal(deviceModalEl);
                } catch (error) {
                    console.error("Errore salvataggio dispositivo: ", error);
                    showNotification("Errore durante il salvataggio.");
                }
            }
            
            async function handleDeleteDevice(deviceId) {
                openConfirmationModal('Conferma Eliminazione', `Sei sicuro di voler eliminare questo dispositivo?`, async () => {
                    try {
                        await deleteDoc(doc(db, "devices", deviceId));
                        closeModal(deviceModalEl);
                        closeConfirmationModal();
                    } catch (error) {
                        console.error("Errore eliminazione: ", error);
                        showNotification("Errore durante l'eliminazione.");
                    }
                });
            }

            // ... (altre funzioni modali e di esportazione rimangono quasi identiche)

            function setupEventListeners() {
                // ... (listeners esistenti)
                resetFiltersBtn.addEventListener('click', () => {
                    searchInputEl.value = '';
                    filterMacroCategoryEl.value = '';
                    filterMarcaEl.value = '';
                    updateAndDisplayLists();
                });
                [searchInputEl, filterMacroCategoryEl, filterMarcaEl].forEach(el => el.addEventListener('input', updateAndDisplayLists));
            }

            // --- FUNZIONE DI INIZIALIZZAZIONE CON FIREBASE ---
            async function initializeAppWithFirebase(user) {
                if (!user) {
                    // Gestisci utente non loggato se necessario
                    console.log("Utente non autenticato.");
                    return;
                }

                // Migrazione da localStorage (solo se non è mai stata fatta)
                if(localStorage.getItem('leaDevicesData') && !localStorage.getItem('firebaseMigrationDone')) {
                    await migrateDataToFirestore();
                }

                // Listener per i dispositivi
                const devicesCol = collection(db, "devices");
                unsubscribeDevices = onSnapshot(devicesCol, (snapshot) => {
                    allDevices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAndDisplayLists();
                    populateFilters(); 
                });

                // Listener per le categorie
                const categoriesCol = collection(db, "categories");
                unsubscribeCategories = onSnapshot(categoriesCol, (snapshot) => {
                    if(snapshot.docs.length > 0) {
                        macroCategoriesList = snapshot.docs[0].data().list || [];
                    } else {
                        // Se non ci sono categorie, crea il documento iniziale
                        const initialCategories = ["Arti Superiori", "Arti Inferiori", "Tronco", "Altro"];
                        addDoc(categoriesCol, { list: initialCategories });
                    }
                    populateFilters();
                });
                
                setupEventListeners();
            }
            
            async function migrateDataToFirestore() {
                 openConfirmationModal(
                    "Migrazione Dati",
                    "Sembra che tu abbia dati salvati localmente. Vuoi copiarli sul cloud? Questa operazione verrà eseguita una sola volta.",
                    async () => {
                        console.log("Inizio migrazione...");
                        const localDevices = JSON.parse(localStorage.getItem('leaDevicesData'));
                        const localCategories = JSON.parse(localStorage.getItem('leaMacroCategories'));
                        
                        const batch = writeBatch(db);
                        const devicesCol = collection(db, "devices");
                        localDevices.forEach(device => {
                            const newDocRef = doc(devicesCol);
                            batch.set(newDocRef, device);
                        });
                        
                        // Sostituisci il documento delle categorie con quello locale
                        const categoriesCol = collection(db, "categories");
                        const categoriesSnapshot = await getDocs(categoriesCol);
                        categoriesSnapshot.forEach(doc => batch.delete(doc.ref)); // Cancella le vecchie
                        const newCatDoc = doc(categoriesCol); // Crea un nuovo doc
                        batch.set(newCatDoc, { list: localCategories });

                        try {
                            await batch.commit();
                            localStorage.setItem('firebaseMigrationDone', 'true');
                            showNotification("Migrazione completata con successo!");
                            closeConfirmationModal();
                        } catch (error) {
                            console.error("Errore durante la migrazione: ", error);
                            showNotification("Errore durante la migrazione dei dati.");
                            closeConfirmationModal();
                        }
                    }
                );
            }

            // --- Flusso di Autenticazione ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Utente autenticato (anonimo):", user.uid);
                    initializeAppWithFirebase(user);
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Errore di login anonimo", error);
                    });
                }
            });

        });
    </script>
</body>
</html>


