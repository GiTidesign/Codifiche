<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Codici LEA (Cloud)</title>
    <!-- Librerie esterne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .highlight { background-color: #fef08a; font-weight: bold; }
        .section-title { border-bottom: 2px solid #0ea5e9; padding-bottom: 8px; margin-bottom: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-title .arrow { transition: transform 0.3s ease; }
        .section-title.collapsed .arrow { transform: rotate(-90deg); }
        
        .macro-category-title {
            background-color: #f8fafc; padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-size: 1.125rem; font-weight: 600; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; margin-top: 1rem; border: 1px solid #e5e7eb;
        }
        .macro-category-title .arrow { transition: transform 0.3s ease; }
        .macro-category-title.collapsed .arrow { transform: rotate(-90deg); }
        .macro-category-content {
            padding-top: 1rem; transition: max-height 0.4s ease-in-out;
            overflow: hidden; max-height: 5000px;
        }
        .macro-category-content.hidden { max-height: 0; padding-top: 0; }

        .device-list-item {
            cursor: pointer; background-color: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s ease-in-out;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .device-list-item:hover {
            transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); border-color: #38bdf8;
        }
        .device-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: contain;
            background-color: #f3f4f6;
            border-radius: 0.25rem;
            margin-bottom: 0.75rem;
        }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); display: none; 
            justify-content: center; align-items: center; 
            transition: opacity 0.3s ease;
        }
        #deviceModal, #categoriesModal, #exportOptionsModal { z-index: 1000; }
        #confirmationModal { z-index: 1010; }
        #notificationModal { z-index: 1020; }

        .modal-box {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 800px; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        #deviceModalBox { height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem; flex-shrink: 0; }
        .modal-header h3 { font-size: 1.5rem; font-weight: 600; }
        .modal-header .close-button { font-size: 1.5rem; color: #9ca3af; cursor: pointer; transition: color 0.2s; }
        .modal-header .close-button:hover { color: #1f2937; }
        .modal-body { flex-grow: 1; overflow-y: auto; min-height: 0; padding-right: 1rem; }
        .modal-footer { border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; }
        
        .sort-dropdown { display: none; position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; right: 0; min-width: 180px; }
        .sort-dropdown button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; }
        .sort-dropdown button:hover { background-color: #f3f4f6; }

        #confirmationModal .modal-box, #notificationModal .modal-box, #categoriesModal .modal-box, #exportOptionsModal .modal-box { max-width: 500px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        
        .category-item-input {
            background-color: transparent; border-color: transparent;
            transition: all 0.2s ease;
        }
        .category-item-input:read-only { pointer-events: none; }
        .category-item-input.editing { background-color: white; border-color: #cbd5e1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Gestore Codici LEA</h1>
            <p class="text-gray-600 mt-2">I tuoi dati sono ora salvati e sincronizzati sul cloud.</p>
        </header>

        <div class="mb-4 p-4 bg-white rounded-lg shadow">
            <h3 class="font-semibold text-lg mb-3">Filtri di Ricerca</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700">Ricerca Testuale</label>
                    <input type="text" id="searchInput"
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"
                           placeholder="Cerca prodotto, marca, codice...">
                </div>
                <div>
                     <label for="filterMacroCategory" class="block text-sm font-medium text-gray-700">Macro Categoria</label>
                     <select id="filterMacroCategory" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        <option value="">Tutte le Macro Categorie</option>
                     </select>
                </div>
                 <div>
                     <label for="filterMarca" class="block text-sm font-medium text-gray-700">Marca</label>
                     <select id="filterMarca" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                         <option value="">Tutte le Marche</option>
                     </select>
                </div>
            </div>
             <div class="mt-4 text-right">
                <button id="resetFiltersBtn" class="text-sm text-gray-600 hover:text-sky-600 hover:underline">Resetta Filtri</button>
            </div>
        </div>


        <section id="sectionSerieWrapper" class="mb-12">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="toggleSerie" class="text-2xl font-semibold text-sky-700 section-title flex-grow">
                    <span>Ortesi di Serie</span>
                    <span class="arrow text-sky-700">&#9660;</span>
                </h2>
                <div class="relative">
                    <button id="sortButtonSerie" class="ml-4 text-gray-500 hover:text-sky-600 p-2 rounded-full" aria-label="Ordina dispositivi di serie"><i class="fas fa-gear"></i></button>
                    <div id="sortDropdownSerie" class="sort-dropdown">
                        <button class="sort-option" data-sort-by="prodotto">Ordina per Prodotto (A-Z)</button>
                        <button class="sort-option" data-sort-by="marca">Ordina per Marca (A-Z)</button>
                    </div>
                </div>
                <button id="addDeviceSerie" class="ml-2 bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors"><i class="fas fa-plus mr-2"></i>Aggiungi</button>
            </div>
            <div id="devicesListSerie" class="space-y-4"></div>
            <p id="noResultsSerie" class="hidden text-center text-gray-500 mt-6">Nessun dispositivo "Di Serie" trovato.</p>
        </section>

        <section id="sectionSuMisuraWrapper" class="mb-12">
             <div class="flex justify-between items-center mb-4">
                <h2 id="toggleSuMisura" class="text-2xl font-semibold text-teal-700 section-title flex-grow">
                    <span>Ortesi su Misura</span>
                    <span class="arrow text-teal-700">&#9660;</span>
                </h2>
                 <div class="relative">
                    <button id="sortButtonSuMisura" class="ml-4 text-gray-500 hover:text-teal-600 p-2 rounded-full" aria-label="Ordina dispositivi su misura"><i class="fas fa-gear"></i></button>
                    <div id="sortDropdownSuMisura" class="sort-dropdown">
                        <button class="sort-option" data-sort-by="prodotto">Ordina per Prodotto (A-Z)</button>
                        <button class="sort-option" data-sort-by="marca">Ordina per Marca (A-Z)</button>
                    </div>
                </div>
                <button id="addDeviceSuMisura" class="ml-2 bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition-colors"><i class="fas fa-plus mr-2"></i>Aggiungi</button>
            </div>
            <div id="devicesListSuMisura" class="space-y-4"></div>
            <p id="noResultsSuMisura" class="hidden text-center text-gray-500 mt-6">Nessun dispositivo "Su Misura" trovato.</p>
        </section>
        
        <div id="noResultsGlobal" class="hidden text-center text-gray-500 mt-10">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="mt-2 text-xl">Nessun risultato trovato.</p>
            <p>Prova a modificare i termini di ricerca.</p>
        </div>

        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Strumenti Avanzati</h3>
            <div class="flex justify-center flex-wrap gap-4">
                <button id="manageCategoriesButton" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-tags mr-2"></i>Gestisci Categorie</button>
                <button id="exportDataButton" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-download mr-2"></i>Esporta JSON</button>
                <button id="exportPdfButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"><i class="fas fa-file-pdf mr-2"></i>Esporta PDF</button>
                <button id="exportCsvButton" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"><i class="fas fa-file-csv mr-2"></i>Esporta CSV</button>
                <button id="importDataButton" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors"><i class="fas fa-upload mr-2"></i>Importa JSON</button>
                <input type="file" id="importFileInput" class="hidden" accept=".json">
            </div>
        </footer>
    </div>
    
    <!-- Modali -->
    <div id="deviceModal" class="modal-overlay">
        <div id="deviceModalBox" class="modal-box">
             <div class="modal-header"></div><div class="modal-body"></div><div class="modal-footer"></div>
        </div>
    </div>
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="confirmationModalTitle" class="text-xl font-semibold text-gray-800">Conferma Azione</h3>
            <p id="confirmationModalText" class="text-gray-600 my-4">Sei sicuro di voler procedere?</p>
            <div class="modal-actions">
                <button id="cancelActionButton" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Annulla</button>
                <button id="confirmActionButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Conferma</button>
            </div>
        </div>
    </div>
    <div id="notificationModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="notificationModalTitle" class="text-xl font-semibold text-gray-800">Notifica</h3>
            <p id="notificationModalText" class="text-gray-600 my-4"></p>
            <div class="modal-actions">
                <button id="notificationOkButton" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600">OK</button>
            </div>
        </div>
    </div>
    <div id="categoriesModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><h3 class="text-xl font-semibold">Gestisci Macro-Categorie</h3><button class="close-button" aria-label="Chiudi">&times;</button></div>
            <div class="modal-body">
                <ul id="categoryList" class="space-y-2"></ul>
                <div class="mt-4 pt-4 border-t"><label for="newCategoryInput" class="font-semibold text-gray-700">Aggiungi Nuova Categoria</label><div class="flex items-center space-x-2 mt-2"><input type="text" id="newCategoryInput" placeholder="Nome nuova categoria..." class="w-full p-2 border rounded"><button id="addCategoryButton" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors">Aggiungi</button></div></div>
            </div>
            <div class="modal-footer"><div class="flex justify-end"><button class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 close-button">Chiudi</button></div></div>
        </div>
    </div>
    <div id="exportOptionsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><h3 class="text-xl font-semibold">Opzioni Esportazione PDF</h3><button class="close-button" aria-label="Chiudi">&times;</button></div>
            <div class="modal-body">
                <form id="exportOptionsForm">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Tipi di Dispositivo</h4>
                            <div class="space-y-1"><label class="flex items-center"><input type="checkbox" id="exportTipoSerie" name="exportTipo" value="Di Serie" checked class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500"><span class="ml-2 text-gray-700">Ortesi di Serie</span></label><label class="flex items-center"><input type="checkbox" id="exportTipoSuMisura" name="exportTipo" value="Su Misura" checked class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500"><span class="ml-2 text-gray-700">Ortesi su Misura</span></label></div>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-gray-700">Macro Categorie</h4>
                                <button type="button" id="toggleAllCategoriesBtn" class="text-xs text-sky-600 hover:underline">Deseleziona tutto</button>
                            </div>
                            <div id="exportCategoriesList" class="space-y-1 max-h-40 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-actions">
                <button class="close-button bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Annulla</button>
                <button id="generatePdfBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Genera PDF</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDW0Bl90TBc-MkRfK7aF4tpe3TxqWjQpuU",
          authDomain: "codifiche-lea.firebaseapp.com",
          projectId: "codifiche-lea",
          storageBucket: "codifiche-lea.appspot.com",
          messagingSenderId: "416568271465",
          appId: "1:416568271465:web:c309850e9a2608fe7938f8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        document.addEventListener('DOMContentLoaded', () => {
            let allDevices = [];
            let currentSort = { serie: 'prodotto', suMisura: 'prodotto' };
            let macroCategoriesList = [];
            let categoriesDocId = null;
            let unsubscribeDevices = null;
            let unsubscribeCategories = null;
            
            // Riferimenti al DOM
            const searchInputEl = document.getElementById('searchInput');
            const filterMacroCategoryEl = document.getElementById('filterMacroCategory');
            const filterMarcaEl = document.getElementById('filterMarca');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const devicesListSerieEl = document.getElementById('devicesListSerie');
            const devicesListSuMisuraEl = document.getElementById('devicesListSuMisura');
            const noResultsSerieEl = document.getElementById('noResultsSerie');
            const noResultsSuMisuraEl = document.getElementById('noResultsSuMisura');
            const noResultsGlobalEl = document.getElementById('noResultsGlobal');
            const manageCategoriesBtn = document.getElementById('manageCategoriesButton');
            const exportDataBtn = document.getElementById('exportDataButton');
            const importDataBtn = document.getElementById('importDataButton');
            const importFileIn = document.getElementById('importFileInput');
            const exportPdfBtn = document.getElementById('exportPdfButton');
            const exportCsvBtn = document.getElementById('exportCsvButton');
            const deviceModalEl = document.getElementById('deviceModal');
            const deviceModalBoxEl = document.getElementById('deviceModalBox');
            const confirmationModalEl = document.getElementById('confirmationModal');
            const notificationModalEl = document.getElementById('notificationModal');
            const notificationModalTextEl = document.getElementById('notificationModalText');
            const notificationOkButton = document.getElementById('notificationOkButton');
            const categoriesModalEl = document.getElementById('categoriesModal');
            const exportOptionsModalEl = document.getElementById('exportOptionsModal');
            let confirmationCallback = null;

            function openModal(modalElement) { modalElement.classList.add('visible'); }
            function closeModal(modalElement) { modalElement.classList.remove('visible'); }
            function showNotification(message) { notificationModalTextEl.textContent = message; openModal(notificationModalEl); }
            function openConfirmationModal(title, text, callback) { confirmationModalEl.querySelector('#confirmationModalTitle').textContent = title; confirmationModalEl.querySelector('#confirmationModalText').textContent = text; confirmationCallback = callback; openModal(confirmationModalEl); }
            function closeConfirmationModal() { closeModal(confirmationModalEl); confirmationCallback = null; }
            function highlightText(text, query) { if (!text) return ''; if (!query || query.length < 1) return text; const sanitizedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`(${sanitizedQuery})`, 'gi'); return text.replace(regex, `<span class="highlight">$1</span>`); }
            
            function createDeviceListItem(device, query) { const item = document.createElement('div'); item.className = 'device-list-item'; const placeholderIcon = `<svg class="w-full h-full text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M24 20.993V24H0v-2.993A1 1 0 001 20h22a1 1 0 001-1.007zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-14h2v6h-2zm0 8h2v2h-2z"></path></svg>`; const imageHtml = `<img src="${device.imageUrl || ''}" onerror="this.onerror=null;this.parentElement.innerHTML='${placeholderIcon}';" class="device-thumbnail" alt="Anteprima ${device.prodotto}">`; item.innerHTML = `<div class="h-32 mb-4 bg-gray-100 rounded flex items-center justify-center">${imageHtml}</div><div class="flex-grow"><div class="font-semibold text-gray-800 truncate">${highlightText(device.prodotto, query)}</div><div class="text-sm text-gray-500">${highlightText(device.marca, query)}</div></div><div class="text-xs text-gray-400 mt-3 pt-2 border-t border-gray-100">${highlightText(device.categoriaOrtesi, query) || 'Senza categoria'}</div>`; item.addEventListener('click', () => openDeviceModal(device)); return item; }

            function populateFilters() {
                const currentCategory = filterMacroCategoryEl.value; const currentMarca = filterMarcaEl.value;
                filterMacroCategoryEl.innerHTML = '<option value="">Tutte le Macro Categorie</option>';
                [...macroCategoriesList].sort().forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; filterMacroCategoryEl.appendChild(option); });
                const marche = [...new Set(allDevices.map(d => d.marca).filter(Boolean))].sort();
                filterMarcaEl.innerHTML = '<option value="">Tutte le Marche</option>';
                marche.forEach(marca => { const option = document.createElement('option'); option.value = marca; option.textContent = marca; filterMarcaEl.appendChild(option); });
                filterMacroCategoryEl.value = currentCategory;
                filterMarcaEl.value = currentMarca;
            }
            function updateAndDisplayLists() { const query = searchInputEl.value.toLowerCase().trim(); const selectedMacroCategory = filterMacroCategoryEl.value; const selectedMarca = filterMarcaEl.value; let filteredDevices = allDevices; if(selectedMacroCategory) { filteredDevices = filteredDevices.filter(d => d.macroCategoria === selectedMacroCategory); } if(selectedMarca) { filteredDevices = filteredDevices.filter(d => d.marca === selectedMarca); } if(query) { filteredDevices = filteredDevices.filter(device => { const searchString = [device.macroCategoria, device.prodotto, device.marca, device.categoriaOrtesi, device.patologie, ...(device.codici || []).map(c => `${c.codice} ${c.descrizione}`)].join(' ').toLowerCase(); return searchString.includes(query); }); } const sortFn = (a, b, key) => (a[key] || '').localeCompare(b[key] || '', 'it', { sensitivity: 'base' }); const serieDevices = filteredDevices.filter(d => d.tipoDispositivo === "Di Serie").sort((a,b) => sortFn(a, b, currentSort.serie)); const suMisuraDevices = filteredDevices.filter(d => d.tipoDispositivo === "Su Misura").sort((a,b) => sortFn(a, b, currentSort.suMisura)); renderGroupedList(devicesListSerieEl, serieDevices, query); renderGroupedList(devicesListSuMisuraEl, suMisuraDevices, query); noResultsSerieEl.classList.toggle('hidden', serieDevices.length > 0); noResultsSuMisuraEl.classList.toggle('hidden', suMisuraDevices.length > 0); noResultsGlobalEl.classList.toggle('hidden', filteredDevices.length > 0 || (serieDevices.length === 0 && suMisuraDevices.length === 0 && query === '' && selectedMacroCategory === '' && selectedMarca === '')); }
            function renderGroupedList(container, devices, query) { container.innerHTML = ''; const isSearching = query.length > 0 || filterMacroCategoryEl.value || filterMarcaEl.value; const grouped = devices.reduce((acc, device) => { const key = device.macroCategoria || 'Senza Categoria'; if (!acc[key]) { acc[key] = []; } acc[key].push(device); return acc; }, {}); const sortedMacroCategories = Object.keys(grouped).sort((a,b) => a.localeCompare(b)); sortedMacroCategories.forEach(macroCat => { const groupContainer = document.createElement('div'); const title = document.createElement('h3'); title.className = `macro-category-title ${!isSearching ? 'collapsed' : ''}`; title.innerHTML = `<span>${macroCat}</span> <span class="arrow text-gray-500">&#9660;</span>`; const contentGrid = document.createElement('div'); contentGrid.className = `macro-category-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 ${!isSearching ? 'hidden' : ''}`; grouped[macroCat].forEach(device => contentGrid.appendChild(createDeviceListItem(device, query))); title.addEventListener('click', () => { title.classList.toggle('collapsed'); contentGrid.classList.toggle('hidden'); }); groupContainer.appendChild(title); groupContainer.appendChild(contentGrid); container.appendChild(groupContainer); }); }
            
            function updateCodeTotals(modalBoxEl) { let grandTotal = 0; const codeRows = modalBoxEl.querySelectorAll('.code-row'); codeRows.forEach(row => { const prezzoInput = row.querySelector('.edit-prezzo-val'); const quantitaInput = row.querySelector('.edit-quantita-val'); const subtotalEl = row.querySelector('.subtotal-display'); const prezzoString = (prezzoInput.value || '0').replace(',', '.'); const prezzo = parseFloat(prezzoString) || 0; const quantita = parseInt(quantitaInput.value, 10) || 1; const subtotal = prezzo * quantita; if(subtotalEl) { subtotalEl.textContent = `Subtotale: ${subtotal.toFixed(2).replace('.', ',')} €`; } grandTotal += subtotal; }); const grandTotalEl = modalBoxEl.querySelector('#grand-total-display'); if (grandTotalEl) { grandTotalEl.textContent = `Totale Complessivo: ${grandTotal.toFixed(2).replace('.', ',')} €`; } }
            
            async function handleSaveDevice(device, isNew) {
                const modalBox = deviceModalBoxEl;
                const updatedData = { 
                    macroCategoria: modalBox.querySelector('.edit-macrocategoria').value, 
                    prodotto: modalBox.querySelector('.edit-prodotto').value, 
                    marca: modalBox.querySelector('.edit-marca').value, 
                    categoriaOrtesi: modalBox.querySelector('.edit-categoria').value, 
                    patologie: modalBox.querySelector('.edit-patologie').value, 
                    note: modalBox.querySelector('.edit-note').value, 
                    tipoDispositivo: device.tipoDispositivo, 
                    codici: Array.from(modalBox.querySelectorAll('.code-row')).map(row => ({ 
                        codice: row.querySelector('.edit-codice-val').value.trim(), 
                        prezzo: row.querySelector('.edit-prezzo-val').value.trim(), 
                        quantita: parseInt(row.querySelector('.edit-quantita-val').value, 10) || 1, 
                        descrizione: row.querySelector('.edit-desc-val').value.trim(), 
                    })).filter(c => c.codice) 
                };

                const imageInput = modalBox.querySelector('#imageUploader');
                const imageFile = imageInput.files[0];
                const removeImage = imageInput.dataset.removeImage === 'true';

                try {
                    if(removeImage && device.imagePath) {
                        const oldImageRef = ref(storage, device.imagePath);
                        await deleteObject(oldImageRef);
                        updatedData.imageUrl = '';
                        updatedData.imagePath = '';
                    } else if (imageFile) {
                        const deviceId = isNew ? doc(collection(db, "devices")).id : device.id; 
                        const imagePath = `images/${deviceId}/${Date.now()}_${imageFile.name}`;
                        const newImageRef = ref(storage, imagePath);
                        
                        await uploadBytes(newImageRef, imageFile);
                        const downloadURL = await getDownloadURL(newImageRef);
                        
                        updatedData.imageUrl = downloadURL;
                        updatedData.imagePath = imagePath;
                    }

                    if (isNew) {
                        await addDoc(collection(db, "devices"), updatedData);
                    } else {
                        await updateDoc(doc(db, "devices", device.id), updatedData);
                    }
                    closeModal(deviceModalEl);
                } catch (error) {
                    console.error("Errore salvataggio dispositivo: ", error);
                    showNotification("Errore durante il salvataggio.");
                }
            }

            async function handleDeleteDevice(deviceId) {
                const deviceToDelete = allDevices.find(d => d.id === deviceId);
                if(!deviceToDelete) return;
                
                openConfirmationModal('Conferma Eliminazione', `Sei sicuro di voler eliminare "${deviceToDelete.prodotto}"?`, async () => {
                    try {
                        if (deviceToDelete.imagePath) {
                            const imageRef = ref(storage, deviceToDelete.imagePath);
                            await deleteObject(imageRef).catch(e => console.warn("Immagine non trovata da eliminare:", e.code));
                        }
                        await deleteDoc(doc(db, "devices", deviceId));
                        closeModal(deviceModalEl);
                        closeConfirmationModal();
                    } catch (error) {
                        console.error("Errore eliminazione: ", error);
                        showNotification("Errore durante l'eliminazione.");
                    }
                });
            }

            function addModalEventListeners(device) {
                const modalBox = deviceModalBoxEl;
                modalBox.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(deviceModalEl));
                const editBtn = modalBox.querySelector('.edit-btn');
                if (editBtn) editBtn.addEventListener('click', () => renderModalContent(device, true));
                const exportSingleBtn = modalBox.querySelector('.export-single-pdf-btn');
                if (exportSingleBtn) exportSingleBtn.addEventListener('click', () => handleExportSingleDevicePDF(device));
                const cancelBtn = modalBox.querySelector('.cancel-edit-btn');
                if (cancelBtn) cancelBtn.addEventListener('click', () => { if (device.id) { renderModalContent(device, false); } else { closeModal(deviceModalEl); } });
                const saveBtn = modalBox.querySelector('.save-btn');
                if (saveBtn) saveBtn.addEventListener('click', () => handleSaveDevice(device, !device.id));
                const deleteBtn = modalBox.querySelector('.delete-btn');
                if (deleteBtn) deleteBtn.addEventListener('click', () => handleDeleteDevice(device.id));
                const addCodeBtn = modalBox.querySelector('.add-code-btn');
                if(addCodeBtn) addCodeBtn.addEventListener('click', () => { const codesContainer = modalBox.querySelector('.edit-codes-container'); const codeRow = document.createElement('div'); codeRow.className = "code-row space-y-1 border-t pt-2 mt-2"; codeRow.innerHTML = `<div class="grid grid-cols-[1fr,90px,70px,auto] gap-2 items-center"><input type="text" class="edit-codice-val p-1 border rounded" placeholder="Codice LEA"><input type="number" class="edit-quantita-val p-1 border rounded text-center" value="1" min="1" placeholder="Q.tà"><input type="text" class="edit-prezzo-val p-1 border rounded" placeholder="Prezzo (€)"><button class="remove-code-btn text-red-500 hover:text-red-700 p-1" aria-label="Rimuovi codice"><i class="fas fa-trash-alt"></i></button></div><input type="text" class="edit-desc-val w-full p-1 border rounded" placeholder="Descrizione del codice"><div class="subtotal-display text-right text-sm font-semibold text-gray-600 pr-10">Subtotale: 0.00 €</div>`; codesContainer.appendChild(codeRow); codeRow.querySelector('.remove-code-btn').addEventListener('click', (e) => { e.currentTarget.closest('.code-row').remove(); updateCodeTotals(modalBox); }); codeRow.querySelectorAll('.edit-prezzo-val, .edit-quantita-val').forEach(input => input.addEventListener('input', () => updateCodeTotals(modalBox))); updateCodeTotals(modalBox); });
                modalBox.querySelectorAll('.remove-code-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.currentTarget.closest('.code-row').remove(); updateCodeTotals(modalBox); }); });
                modalBox.querySelectorAll('.edit-prezzo-val, .edit-quantita-val').forEach(input => input.addEventListener('input', () => updateCodeTotals(modalBox)));
                
                const imageUploader = modalBox.querySelector('#imageUploader');
                const imagePreview = modalBox.querySelector('#imagePreview');
                const removeImageBtn = modalBox.querySelector('#removeImageBtn');
                if(imageUploader) {
                    imageUploader.dataset.removeImage = 'false';
                    imageUploader.addEventListener('change', () => {
                        if (imageUploader.files && imageUploader.files[0]) {
                            const reader = new FileReader();
                            reader.onload = (e) => { imagePreview.src = e.target.result; };
                            reader.readAsDataURL(imageUploader.files[0]);
                            imageUploader.dataset.removeImage = 'false';
                            removeImageBtn.textContent = "Rimuovi Nuova Immagine";
                        }
                    });
                }
                if(removeImageBtn) {
                    removeImageBtn.addEventListener('click', () => {
                        imagePreview.src = '';
                        imageUploader.value = '';
                        imageUploader.dataset.removeImage = 'true';
                        removeImageBtn.textContent = "Immagine Rimossa";
                    });
                }
            }
            function renderModalContent(device, isEditing) {
                const modalHeader = deviceModalBoxEl.querySelector('.modal-header'); const modalBody = deviceModalBoxEl.querySelector('.modal-body'); const modalFooter = deviceModalBoxEl.querySelector('.modal-footer');
                modalHeader.innerHTML = `<h3 class="text-xl font-bold">${isEditing ? (device.id ? 'Modifica Dispositivo' : 'Nuovo Dispositivo') : device.prodotto}</h3><button class="close-modal-btn text-2xl text-gray-500 hover:text-gray-800" aria-label="Chiudi modale">&times;</button>`;
                if (isEditing) {
                    const macroCategoryOptions = macroCategoriesList.map(cat => `<option value="${cat}" ${device.macroCategoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
                    const codesHtml = (device.codici && device.codici.length > 0 ? device.codici : [{codice:'', prezzo:'', descrizione:'', quantita: 1}]).map(c => { const prezzoVal = parseFloat(String(c.prezzo || '0').replace(',', '.')) || 0; const quantitaVal = parseInt(c.quantita, 10) || 1; const subtotal = prezzoVal * quantitaVal; return `<div class="code-row space-y-1 border-t pt-2 mt-2 first:border-t-0 first:pt-0 first:mt-0"><div class="grid grid-cols-[1fr,90px,70px,auto] gap-2 items-center"><input type="text" value="${c.codice || ''}" class="edit-codice-val p-1 border rounded" placeholder="Codice LEA"><input type="number" value="${quantitaVal}" min="1" class="edit-quantita-val p-1 border rounded text-center" placeholder="Q.tà"><input type="text" value="${c.prezzo || ''}" class="edit-prezzo-val p-1 border rounded" placeholder="Prezzo (€)"><button class="remove-code-btn text-red-500 hover:text-red-700 p-1" aria-label="Rimuovi codice"><i class="fas fa-trash-alt"></i></button></div><input type="text" value="${c.descrizione || ''}" class="edit-desc-val w-full p-1 border rounded" placeholder="Descrizione del codice"><div class="subtotal-display text-right text-sm font-semibold text-gray-600 pr-10">Subtotale: ${subtotal.toFixed(2).replace('.',',')} €</div></div>`; }).join('');
                    modalBody.innerHTML = `<div class="flex-col space-y-4"><div><label class="font-semibold text-gray-600 text-sm">Immagine</label><div class="mt-1 flex items-center space-x-4"><img id="imagePreview" src="${device.imageUrl || ''}" class="h-20 w-20 object-contain bg-gray-100 rounded" alt="Anteprima"><div class="flex-grow"><input type="file" id="imageUploader" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/><button type="button" id="removeImageBtn" class="mt-2 text-xs text-red-600 hover:underline">Rimuovi Immagine Esistente</button></div></div></div><div><label class="font-semibold text-gray-600 text-sm">Macro Categoria</label><select class="edit-macrocategoria w-full p-2 border rounded mt-1 bg-white">${macroCategoryOptions}</select></div><div><label class="font-semibold text-gray-600 text-sm">Nome Prodotto</label><input type="text" value="${device.prodotto || ''}" class="edit-prodotto w-full p-2 border rounded mt-1" placeholder="Nome Prodotto"></div><div><label class="font-semibold text-gray-600 text-sm">Marca</label><input type="text" value="${device.marca || ''}" class="edit-marca w-full p-2 border rounded mt-1" placeholder="Marca"></div><div><label class="font-semibold text-gray-600 text-sm">Categoria Specifica</label><input type="text" value="${device.categoriaOrtesi || ''}" class="edit-categoria w-full p-2 border rounded mt-1" placeholder="Es. Ginocchio, Piede..."></div><div><label class="font-semibold text-gray-600 text-sm">Patologie (separate da virgola)</label><textarea class="edit-patologie w-full p-2 border rounded h-24 mt-1" placeholder="Patologie">${device.patologie || ''}</textarea></div><div><label class="font-semibold text-gray-600 text-sm">Note</label><textarea class="edit-note w-full p-2 border rounded h-24 mt-1" placeholder="Aggiungi note...">${device.note || ''}</textarea></div><h4 class="font-semibold pt-2 border-t">Codici LEA</h4><div class="edit-codes-container space-y-2 max-h-48 overflow-y-auto pr-2">${codesHtml}</div><button class="add-code-btn mt-2 text-sm text-sky-600 hover:text-sky-800">+ Aggiungi Codice</button><div id="grand-total-display" class="text-right text-lg font-bold text-gray-800 mt-2 pr-10"></div></div>`;
                    modalFooter.innerHTML = `<div class="flex justify-between items-center"><button class="delete-btn text-gray-400 hover:text-red-500" ${!device.id ? 'style="display:none;"' : ''}><i class="fas fa-trash mr-1"></i> Elimina</button><div class="space-x-2"><button class="cancel-edit-btn bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">Annulla</button><button class="save-btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Salva</button></div></div>`;
                    updateCodeTotals(deviceModalBoxEl);
                } else {
                    let grandTotal = 0;
                    const codesHtml = (device.codici && device.codici.length > 0) ? device.codici.map(c => { const prezzoVal = parseFloat(String(c.prezzo || '0').replace(',', '.')) || 0; const quantitaVal = parseInt(c.quantita, 10) || 1; const subtotal = prezzoVal * quantitaVal; grandTotal += subtotal; return `<li class="p-2 bg-gray-50 rounded"><div class="flex justify-between items-baseline"><strong class="text-base">${c.codice}</strong><span class="text-sm">Q.tà: ${quantitaVal} x ${prezzoVal.toFixed(2).replace('.',',')} €</span><span class="text-green-700 font-semibold">Subtotale: ${subtotal.toFixed(2).replace('.',',')} €</span></div><p class="text-gray-600 mt-1 text-sm">${c.descrizione || 'Nessuna descrizione'}</p></li>`; }).join('') : '<li class="text-gray-500">Nessun codice associato.</li>';
                     modalBody.innerHTML = `<div class="space-y-4"><div class="flex items-start space-x-4"><img src="${device.imageUrl || ''}" onerror="this.style.display='none'" class="w-1/3 rounded-lg object-contain bg-gray-100" alt="${device.prodotto}"><div class="w-2/3 space-y-3"><p><strong>Marca:</strong> ${device.marca || 'N/D'}</p><p><strong>Macro Categoria:</strong> <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">${device.macroCategoria || 'N/D'}</span></p><p><strong>Categoria Specifica:</strong> ${device.categoriaOrtesi || 'N/D'}</p></div></div><div><strong>Patologie:</strong> <div class="mt-1 p-2 bg-gray-50 rounded text-sm">${device.patologie ? device.patologie.replace(/,/g, ', ') : 'N/D'}</div></div><div><strong>Note:</strong> <div class="mt-1 p-2 bg-gray-50 rounded text-sm">${device.note || 'Nessuna nota.'}</div></div><h4 class="font-semibold pt-2 border-t">Codici Nuovi LEA</h4><ul class="space-y-2">${codesHtml}</ul><div class="text-right text-xl font-bold text-gray-800 mt-4 pt-2 border-t">Totale Complessivo: ${grandTotal.toFixed(2).replace('.',',')} €</div></div>`;
                     modalFooter.innerHTML = `<div class="flex justify-end gap-2"><button class="export-single-pdf-btn bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"><i class="fas fa-file-pdf mr-2"></i>Esporta PDF</button><button class="edit-btn bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600"><i class="fas fa-pencil-alt mr-2"></i>Modifica</button></div>`;
                }
                addModalEventListeners(device);
            }
            function openDeviceModal(device) { renderModalContent(device, !device.id); openModal(deviceModalEl); }
            function handleAddNewDevice(tipo) { const newDevice = { macroCategoria: macroCategoriesList.includes("Altro") ? "Altro" : macroCategoriesList[0], prodotto: "", marca: "", categoriaOrtesi: "", patologie: "", note: "", codici: [], tipoDispositivo: tipo, id: null }; openDeviceModal(newDevice); }
            async function handleUpdateCategory(oldName, newName) { const trimmedNewName = newName.trim(); if (!trimmedNewName) { showNotification("Il nome della categoria non può essere vuoto."); return; } if (macroCategoriesList.find(c => c.toLowerCase() === trimmedNewName.toLowerCase() && c.toLowerCase() !== oldName.toLowerCase())) { showNotification("Questa categoria esiste già."); return; } const batch = writeBatch(db); const q = query(collection(db, "devices"), where("macroCategoria", "==", oldName)); const querySnapshot = await getDocs(q); querySnapshot.forEach((doc) => { batch.update(doc.ref, { macroCategoria: trimmedNewName }); }); const updatedList = macroCategoriesList.map(c => c === oldName ? trimmedNewName : c); const catDocRef = doc(db, "categories", categoriesDocId); batch.update(catDocRef, { list: updatedList }); try { await batch.commit(); } catch (e) { console.error("Errore aggiornamento categoria:", e); } }
            async function handleDeleteCategory(categoryToDelete) { openConfirmationModal('Conferma Eliminazione Categoria', `Sei sicuro di voler eliminare "${categoryToDelete}"? I dispositivi associati verranno spostati in "Altro".`, async () => { const batch = writeBatch(db); const q = query(collection(db, "devices"), where("macroCategoria", "==", categoryToDelete)); const querySnapshot = await getDocs(q); querySnapshot.forEach((doc) => { batch.update(doc.ref, { macroCategoria: "Altro" }); }); const updatedList = macroCategoriesList.filter(c => c !== categoryToDelete); const catDocRef = doc(db, "categories", categoriesDocId); batch.update(catDocRef, { list: updatedList }); try { await batch.commit(); closeConfirmationModal(); } catch(e) { console.error(e); } }); }
            async function handleAddCategory(newCat) { if(newCat && !macroCategoriesList.find(c => c.toLowerCase() === newCat.toLowerCase())) { const updatedList = [...macroCategoriesList, newCat]; const catDocRef = doc(db, "categories", categoriesDocId); try { await updateDoc(catDocRef, { list: updatedList }); } catch(e) { console.error(e); } } else if (!newCat) { showNotification("Il nome della categoria non può essere vuoto."); } else { showNotification("Questa categoria esiste già."); } }
            function renderCategoriesModal() { const categoryListEl = document.getElementById('categoryList'); categoryListEl.innerHTML = ''; macroCategoriesList.forEach(cat => { const li = document.createElement('li'); li.className = 'flex justify-between items-center p-2 bg-gray-100 rounded space-x-2'; const input = document.createElement('input'); input.type = 'text'; input.value = cat; input.readOnly = true; input.className = 'category-item-input flex-grow p-1 border rounded'; input.dataset.originalName = cat; const buttonsDiv = document.createElement('div'); buttonsDiv.className = 'flex items-center space-x-2'; const editBtn = document.createElement('button'); editBtn.className = 'edit-category-btn text-blue-500 hover:text-blue-700'; editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>'; const saveBtn = document.createElement('button'); saveBtn.className = 'save-category-btn text-green-500 hover:text-green-700 hidden'; saveBtn.innerHTML = '<i class="fas fa-save"></i>'; const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-category-btn text-red-500 hover:text-red-700'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; if (cat === 'Altro') { editBtn.disabled = true; editBtn.classList.add('opacity-50', 'cursor-not-allowed'); deleteBtn.disabled = true; deleteBtn.classList.add('opacity-50', 'cursor-not-allowed'); } else { editBtn.onclick = () => { input.readOnly = false; input.classList.add('editing'); input.focus(); editBtn.classList.add('hidden'); saveBtn.classList.remove('hidden'); }; saveBtn.onclick = () => handleUpdateCategory(input.dataset.originalName, input.value); deleteBtn.onclick = () => handleDeleteCategory(cat); } li.appendChild(input); buttonsDiv.appendChild(editBtn); buttonsDiv.appendChild(saveBtn); buttonsDiv.appendChild(deleteBtn); li.appendChild(buttonsDiv); categoryListEl.appendChild(li); }); }
            function openExportOptionsModal() { const listEl = document.getElementById('exportCategoriesList'); listEl.innerHTML = ''; macroCategoriesList.forEach(cat => { const label = document.createElement('label'); label.className = 'flex items-center'; label.innerHTML = `<input type="checkbox" name="exportCategory" value="${cat}" checked class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500"><span class="ml-2 text-gray-700">${cat}</span>`; listEl.appendChild(label); }); document.getElementById('toggleAllCategoriesBtn').textContent = 'Deseleziona tutto'; openModal(exportOptionsModalEl); }
            function generateCustomPDF() { const form = document.getElementById('exportOptionsForm'); const selectedTipi = Array.from(form.querySelectorAll('input[name="exportTipo"]:checked')).map(el => el.value); const selectedCategories = Array.from(form.querySelectorAll('input[name="exportCategory"]:checked')).map(el => el.value); if (selectedTipi.length === 0 || selectedCategories.length === 0) { showNotification("Seleziona almeno un tipo di dispositivo e una categoria da esportare."); return; } const devicesToExport = allDevices.filter(device => selectedTipi.includes(device.tipoDispositivo) && selectedCategories.includes(device.macroCategoria)); if (devicesToExport.length === 0) { showNotification("Nessun dispositivo corrisponde ai filtri selezionati."); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18); doc.text("Catalogo Dispositivi LEA (Personalizzato)", 14, 22); const createTable = (title, devices) => { if (devices.length === 0) return false; const head = [['Prodotto', 'Marca', 'Macro Cat.', 'Cat. Specifica', 'Codici']]; const body = devices.map(d => [d.prodotto || '', d.marca || '', d.macroCategoria || '', d.categoriaOrtesi || '', (d.codici || []).map(c => c.codice).join(', ')]); doc.autoTable({ head, body, didDrawPage: (data) => { doc.setFontSize(20); doc.text(title, data.settings.margin.left, 15); }, margin: { top: 30 } }); return true; }; let pageAdded = false; if (selectedTipi.includes('Di Serie')) { const serieDevices = devicesToExport.filter(d => d.tipoDispositivo === "Di Serie"); if (serieDevices.length > 0) { createTable("Ortesi di Serie", serieDevices); pageAdded = true; } } if (selectedTipi.includes('Su Misura')) { const suMisuraDevices = devicesToExport.filter(d => d.tipoDispositivo === "Su Misura"); if (suMisuraDevices.length > 0) { if(pageAdded) doc.addPage(); createTable("Ortesi su Misura", suMisuraDevices); } } doc.save('catalogo_lea_personalizzato.pdf'); closeModal(exportOptionsModalEl); }
            function handleExportSingleDevicePDF(device) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let grandTotal = 0; let yPos = 115; doc.setFontSize(22); doc.text("Scheda Tecnica Dispositivo", 14, 20); doc.setFontSize(12); doc.text(`Prodotto: ${device.prodotto || 'N/D'}`, 14, 40); doc.text(`Marca: ${device.marca || 'N/D'}`, 14, 50); doc.text(`Tipo: ${device.tipoDispositivo || 'N/D'}`, 14, 60); doc.text(`Macro Categoria: ${device.macroCategoria || 'N/D'}`, 14, 70); doc.text(`Categoria Specifica: ${device.categoriaOrtesi || 'N/D'}`, 14, 80); doc.setFontSize(14); doc.text("Patologie:", 14, 95); doc.setFontSize(11); yPos = doc.splitTextToSize(device.patologie || 'Nessuna patologia specificata.', 180).length * 5 + 102; doc.text(device.patologie || 'Nessuna patologia specificata.', 14, 102, { maxWidth: 180 }); doc.setFontSize(14); doc.text("Note:", 14, yPos); doc.setFontSize(11); yPos = doc.splitTextToSize(device.note || 'Nessuna nota.', 180).length * 5 + yPos + 7; doc.text(device.note || 'Nessuna nota.', 14, yPos - 5, { maxWidth: 180 }); yPos += 10; doc.setFontSize(14); doc.text("Codici LEA Associati:", 14, yPos); const head = [['Codice', 'Prezzo (€)', 'Q.tà', 'Subtotale (€)', 'Descrizione']]; const body = (device.codici && device.codici.length > 0) ? device.codici.map(c => { const prezzo = parseFloat(String(c.prezzo || '0').replace(',','.')) || 0; const quantita = parseInt(c.quantita, 10) || 1; const subtotal = prezzo * quantita; grandTotal += subtotal; return [c.codice || '', prezzo.toFixed(2).replace('.',','), quantita, subtotal.toFixed(2).replace('.',','), c.descrizione || '']}) : [['Nessun codice', '', '', '', '']]; doc.autoTable({ head, body, startY: yPos + 5, theme: 'grid', headStyles: { fillColor: [41, 128, 186] }, footStyles: { fontStyle: 'bold', fontSize: 12, fillColor: [230, 230, 230], textColor: 0 }, foot: [['', '', '', 'Totale:', `${grandTotal.toFixed(2).replace('.',',')} €`]] }); doc.save(`scheda_${(device.prodotto || 'dispositivo').replace(/\s+/g, '_')}.pdf`); }
            function handleExportCSV() { if (allDevices.length === 0) { showNotification("Nessun dato da esportare."); return; } const headers = ['ID', 'Prodotto', 'Marca', 'Tipo Dispositivo', 'Macro Categoria', 'Categoria Specifica', 'Patologie', 'Note', 'Codice LEA', 'Quantita', 'Prezzo', 'Descrizione Codice']; let csvContent = headers.join(',') + '\r\n'; allDevices.forEach(device => { if (device.codici && device.codici.length > 0) { device.codici.forEach(code => { const row = [ device.id, `"${(device.prodotto || '').replace(/"/g, '""')}"`, `"${(device.marca || '').replace(/"/g, '""')}"`, device.tipoDispositivo, device.macroCategoria, device.categoriaOrtesi, `"${(device.patologie || '').replace(/"/g, '""')}"`, `"${(device.note || '').replace(/"/g, '""')}"`, code.codice, code.quantita || 1, code.prezzo, `"${(code.descrizione || '').replace(/"/g, '""')}"` ]; csvContent += row.join(',') + '\r\n'; }); } else { const row = [ device.id, `"${(device.prodotto || '').replace(/"/g, '""')}"`, `"${(device.marca || '').replace(/"/g, '""')}"`, device.tipoDispositivo, device.macroCategoria, device.categoriaOrtesi, `"${(device.patologie || '').replace(/"/g, '""')}"`, `"${(device.note || '').replace(/"/g, '""')}"`, '', '', '', '' ]; csvContent += row.join(',') + '\r\n'; } }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "catalogo_lea.csv"); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            
            function setupEventListeners() {
                document.getElementById('addDeviceSerie').addEventListener('click', () => handleAddNewDevice('Di Serie'));
                document.getElementById('addDeviceSuMisura').addEventListener('click', () => handleAddNewDevice('Su Misura'));
                const setupSort = (btn, dropdown, type) => { btn.addEventListener('click', (e) => { e.stopPropagation(); if(dropdown.id !== 'sortDropdownSerie') document.getElementById('sortDropdownSerie').style.display = 'none'; if(dropdown.id !== 'sortDropdownSuMisura') document.getElementById('sortDropdownSuMisura').style.display = 'none'; dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block'; }); dropdown.addEventListener('click', (e) => { if (e.target.classList.contains('sort-option')) { currentSort[type] = e.target.dataset.sortBy; updateAndDisplayLists(); dropdown.style.display = 'none'; } }); };
                setupSort(document.getElementById('sortButtonSerie'), document.getElementById('sortDropdownSerie'), 'serie');
                setupSort(document.getElementById('sortButtonSuMisura'), document.getElementById('sortDropdownSuMisura'), 'suMisura');
                document.addEventListener('click', () => { document.getElementById('sortDropdownSerie').style.display = 'none'; document.getElementById('sortDropdownSuMisura').style.display = 'none'; });
                exportDataBtn.addEventListener('click', () => { if (allDevices.length === 0) { showNotification("Nessun dato da esportare."); return; } const dataStr = JSON.stringify(allDevices, null, 2); const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr); const exportFileDefaultName = `lea_backup_${new Date().toISOString().slice(0,10)}.json`; const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportFileDefaultName); linkElement.click(); });
                importDataBtn.addEventListener('click', () => importFileIn.click());
                importFileIn.addEventListener('change', (event) => { if(!event.target.files[0]) return; const reader = new FileReader(); reader.onload = (e) => { openConfirmationModal('Conferma Importazione Dati','ATTENZIONE: Stai per sovrascrivere tutti i dati esistenti. Vuoi procedere?', () => { try { const importedData = JSON.parse(e.target.result); if (!Array.isArray(importedData)) throw new Error("Dati non validi."); allDevices = importedData;  const importedCategories = [...new Set(importedData.map(d => d.macroCategoria).filter(Boolean))]; if(!importedCategories.includes('Altro')) importedCategories.push('Altro'); macroCategoriesList = importedCategories; saveDataToLocalStorage(); updateAndDisplayLists(); populateFilters(); showNotification("Dati importati con successo!"); } catch (err) { console.error("Errore importazione:", err); showNotification("Errore: Il file non è valido o il formato JSON non è corretto."); } closeConfirmationModal(); }); }; reader.readAsText(event.target.files[0]); event.target.value = ''; });
                manageCategoriesBtn.addEventListener('click', () => { renderCategoriesModal(); openModal(categoriesModalEl); });
                categoriesModalEl.querySelectorAll('.close-button').forEach(btn => btn.addEventListener('click', () => closeModal(categoriesModalEl)));
                document.getElementById('addCategoryButton').addEventListener('click', () => { const input = document.getElementById('newCategoryInput'); const newCat = input.value.trim(); handleAddCategory(newCat); input.value = ''; });
                exportPdfBtn.addEventListener('click', openExportOptionsModal);
                exportCsvBtn.addEventListener('click', handleExportCSV);
                document.getElementById('generatePdfBtn').addEventListener('click', generateCustomPDF);
                exportOptionsModalEl.querySelectorAll('.close-button').forEach(btn => btn.addEventListener('click', () => closeModal(exportOptionsModalEl)));
                document.getElementById('toggleAllCategoriesBtn').addEventListener('click', (e) => { const checkboxes = exportOptionsModalEl.querySelectorAll('input[name="exportCategory"]'); const allChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !allChecked); e.target.textContent = allChecked ? 'Seleziona tutto' : 'Deseleziona tutto'; });
                const toggleMainSection = (toggleElement, listContainer) => { listContainer.classList.toggle('hidden'); toggleElement.classList.toggle('collapsed'); };
                const devicesListSerie = document.getElementById('devicesListSerie');
                const devicesListSuMisura = document.getElementById('devicesListSuMisura');
                document.getElementById('toggleSerie').addEventListener('click', () => toggleMainSection(document.getElementById('toggleSerie'), devicesListSerie));
                document.getElementById('toggleSuMisura').addEventListener('click', () => toggleMainSection(document.getElementById('toggleSuMisura'), devicesListSuMisura));
                searchInputEl.addEventListener('input', () => updateAndDisplayLists());
                filterMacroCategoryEl.addEventListener('change', () => updateAndDisplayLists());
                filterMarcaEl.addEventListener('change', () => updateAndDisplayLists());
                resetFiltersBtn.addEventListener('click', () => { searchInputEl.value = ''; filterMacroCategoryEl.value = ''; filterMarcaEl.value = ''; updateAndDisplayLists(); });
                confirmationModalEl.querySelector('#cancelActionButton').addEventListener('click', closeConfirmationModal);
                confirmationModalEl.querySelector('#confirmActionButton').addEventListener('click', () => { if (confirmationCallback) confirmationCallback(); });
                notificationOkButton.addEventListener('click', () => closeModal(notificationModalEl));
            }
            
            function initializeAppWithFirebase(user) {
                if (!user) { console.log("Utente non autenticato."); return; }
                setupEventListeners();
                const devicesCol = collection(db, "devices");
                unsubscribeDevices = onSnapshot(devicesCol, (snapshot) => {
                    allDevices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAndDisplayLists();
                    populateFilters(); 
                }, (error) => {
                    console.error("Errore listener dispositivi:", error);
                });
                const categoriesCol = collection(db, "categories");
                unsubscribeCategories = onSnapshot(categoriesCol, (snapshot) => {
                    if(snapshot.docs.length > 0) {
                        categoriesDocId = snapshot.docs[0].id;
                        macroCategoriesList = snapshot.docs[0].data().list || [];
                    } else {
                        const initialCategories = ["Arti Superiori", "Arti Inferiori", "Tronco", "Altro"];
                        addDoc(categoriesCol, { list: initialCategories });
                    }
                    populateFilters();
                }, (error) => {
                    console.error("Errore listener categorie:", error);
                });
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    initializeAppWithFirebase(user);
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Errore di login anonimo", error);
                    });
                }
            });
        });
    </script>
</body>
</html>


